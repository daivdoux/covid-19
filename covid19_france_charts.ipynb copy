{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 804,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "'\\n\\nLICENSE MIT\\n2020\\nGuillaume Rozier\\nWebsite : http://www.guillaumerozier.fr\\nMail : guillaume.rozier@telecomnancy.net\\n\\n'"
      ]
     },
     "execution_count": 804,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "\"\"\"\n",
    "\n",
    "LICENSE MIT\n",
    "2020\n",
    "Guillaume Rozier\n",
    "Website : http://www.guillaumerozier.fr\n",
    "Mail : guillaume.rozier@telecomnancy.net\n",
    "\n",
    "\"\"\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 805,
   "metadata": {},
   "outputs": [],
   "source": [
    "from multiprocessing import Pool\n",
    "import requests\n",
    "import pandas as pd\n",
    "import plotly.graph_objects as go\n",
    "import plotly.express as px\n",
    "import plotly\n",
    "from plotly.subplots import make_subplots\n",
    "from datetime import datetime\n",
    "from tqdm import tqdm\n",
    "import imageio\n",
    "import json\n",
    "\n",
    "import locale\n",
    "locale.setlocale(locale.LC_ALL, 'fr_FR.UTF-8')\n",
    "\n",
    "colors = px.colors.qualitative.D3 + px.colors.qualitative.Dark24 + plotly.colors.DEFAULT_PLOTLY_COLORS + px.colors.qualitative.Plotly + px.colors.qualitative.Alphabet"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 806,
   "metadata": {},
   "outputs": [],
   "source": [
    "show_charts = False"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 879,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "36it [00:01, 30.51it/s]                      \n"
     ]
    }
   ],
   "source": [
    "def download_data():\n",
    "    pbar = tqdm(total=8)\n",
    "    url_metadata = \"https://www.data.gouv.fr/fr/organizations/sante-publique-france/datasets-resources.csv\"\n",
    "    url_geojson = \"https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements.geojson\"\n",
    "    pbar.update(1)\n",
    "    metadata = requests.get(url_metadata)\n",
    "    pbar.update(2)\n",
    "    geojson = requests.get(url_geojson)\n",
    "    pbar.update(3)\n",
    "    with open('data/france/metadata.csv', 'wb') as f:\n",
    "        f.write(metadata.content)\n",
    "    pbar.update(4)\n",
    "    with open('data/france/dep.geojson', 'wb') as f:\n",
    "        f.write(geojson.content)\n",
    "    pbar.update(5)\n",
    "    df_metadata = pd.read_csv('data/france/metadata.csv', sep=\";\")\n",
    "    url_data = df_metadata[df_metadata['url'].str.contains(\"/donnees-hospitalieres-covid19\")][\"url\"].values[0]\n",
    "    url_data_new = df_metadata[df_metadata['url'].str.contains(\"/donnees-hospitalieres-nouveaux\")][\"url\"].values[0]\n",
    "    \n",
    "    pbar.update(6)\n",
    "    data = requests.get(url_data)\n",
    "    \n",
    "    data_new = requests.get(url_data_new)\n",
    "    pbar.update(7)\n",
    "    with open('data/france/donnes-hospitalieres-covid19.csv', 'wb') as f:\n",
    "        f.write(data.content)\n",
    "        \n",
    "    with open('data/france/donnes-hospitalieres-covid19-nouveaux.csv', 'wb') as f:\n",
    "        f.write(data_new.content)\n",
    "        \n",
    "    pbar.update(8)\n",
    "\n",
    "download_data()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 891,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "10it [00:02,  4.20it/s]              \n"
     ]
    }
   ],
   "source": [
    "def import_data():\n",
    "    \n",
    "    pbar = tqdm(total=4)\n",
    "    pbar.update(1)\n",
    "    df = pd.read_csv('data/france/donnes-hospitalieres-covid19.csv', sep=\";\")\n",
    "    df_new = pd.read_csv('data/france/donnes-hospitalieres-covid19-nouveaux.csv', sep=\";\")\n",
    "    \n",
    "    df_regions = pd.read_csv('data/france/departments_regions_france_2016.csv', sep=\",\")\n",
    "    df_reg_pop = pd.read_csv('data/france/population_regions.csv', sep=\",\")\n",
    "    df_dep_pop = pd.read_csv('data/france/dep-pop.csv', sep=\";\")\n",
    "    \n",
    "    ###\n",
    "    df = df.merge(df_regions, left_on='dep', right_on='departmentCode')\n",
    "    df = df.merge(df_reg_pop, left_on='regionName', right_on='regionName')\n",
    "    df = df.merge(df_dep_pop, left_on='dep', right_on='dep')\n",
    "    df = df[df[\"sexe\"] == 0]\n",
    "    df['hosp_nonrea'] = df['hosp'] - df['rea']\n",
    "    \n",
    "    df_new = df_new.merge(df_regions, left_on='dep', right_on='departmentCode')\n",
    "    df_new = df_new.merge(df_reg_pop, left_on='regionName', right_on='regionName')\n",
    "    df_new = df_new.merge(df_dep_pop, left_on='dep', right_on='dep')\n",
    "    df_new['incid_hosp_nonrea'] = df_new['incid_hosp'] - df_new['incid_rea']\n",
    "    \n",
    "    pbar.update(2)\n",
    "    \n",
    "    df['rea_pop'] = df['rea']/df['regionPopulation']*100000\n",
    "    df['rea_deppop'] = df['rea']/df['departmentPopulation']*100000\n",
    "    \n",
    "    df['rad_pop'] = df['rad']/df['regionPopulation']*100000\n",
    "    \n",
    "    df['dc_pop'] = df['dc']/df['regionPopulation']*100000\n",
    "    df['dc_deppop'] = df['dc']/df['departmentPopulation']*100000\n",
    "    \n",
    "    df['hosp_pop'] = df['hosp']/df['regionPopulation']*100000\n",
    "    df['hosp_nonrea_pop'] = df['hosp_nonrea']/df['regionPopulation']*100000\n",
    "    pbar.update(3)\n",
    "    df_confirmed = pd.read_csv('data/data_confirmed.csv')\n",
    "    pbar.update(4)\n",
    "    \n",
    "    deps = list(dict.fromkeys(list(df['departmentCode'].values))) \n",
    "    for d in deps:\n",
    "        for col in [\"dc\", \"rad\", \"rea\", \"hosp_nonrea\", \"hosp\"]:\n",
    "            vals = df[df[\"dep\"] == d][col].diff()\n",
    "            df.loc[vals.index,col+\"_new\"] = vals\n",
    "            df.loc[vals.index,col+\"_new_deppop\"] = vals / df.loc[vals.index,\"departmentPopulation\"]*100000\n",
    "    dates = list(dict.fromkeys(list(df['jour'].values))) \n",
    "    \n",
    "    return df, df_confirmed, dates, df_new\n",
    "\n",
    "df, df_confirmed, dates, df_new = import_data()\n",
    "\n",
    "df_region = df.groupby(['regionName', 'jour', 'regionPopulation']).sum().reset_index()\n",
    "df_region[\"hosp_regpop\"] = df_region[\"hosp\"] / df_region[\"regionPopulation\"]*1000000 \n",
    "\n",
    "df_new_region = df_new.groupby(['regionName', 'jour']).sum().reset_index()\n",
    "df_france = df.groupby('jour').sum().reset_index()\n",
    "\n",
    "regions = list(dict.fromkeys(list(df['regionName'].values))) "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 881,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>jour</th>\n",
       "      <th>sexe</th>\n",
       "      <th>hosp</th>\n",
       "      <th>rea</th>\n",
       "      <th>rad</th>\n",
       "      <th>dc</th>\n",
       "      <th>regionCode</th>\n",
       "      <th>regionPopulation</th>\n",
       "      <th>departmentPopulation</th>\n",
       "      <th>hosp_nonrea</th>\n",
       "      <th>...</th>\n",
       "      <th>dc_new</th>\n",
       "      <th>dc_new_deppop</th>\n",
       "      <th>rad_new</th>\n",
       "      <th>rad_new_deppop</th>\n",
       "      <th>rea_new</th>\n",
       "      <th>rea_new_deppop</th>\n",
       "      <th>hosp_nonrea_new</th>\n",
       "      <th>hosp_nonrea_new_deppop</th>\n",
       "      <th>hosp_new</th>\n",
       "      <th>hosp_new_deppop</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2020-03-18</td>\n",
       "      <td>0</td>\n",
       "      <td>2972</td>\n",
       "      <td>771</td>\n",
       "      <td>816</td>\n",
       "      <td>218</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>2201</td>\n",
       "      <td>...</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2020-03-19</td>\n",
       "      <td>0</td>\n",
       "      <td>4073</td>\n",
       "      <td>1002</td>\n",
       "      <td>1180</td>\n",
       "      <td>327</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>3071</td>\n",
       "      <td>...</td>\n",
       "      <td>109.0</td>\n",
       "      <td>15.396317</td>\n",
       "      <td>364.0</td>\n",
       "      <td>40.116786</td>\n",
       "      <td>231.0</td>\n",
       "      <td>23.731770</td>\n",
       "      <td>870.0</td>\n",
       "      <td>95.763670</td>\n",
       "      <td>1101.0</td>\n",
       "      <td>119.495440</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>2020-03-20</td>\n",
       "      <td>0</td>\n",
       "      <td>5226</td>\n",
       "      <td>1297</td>\n",
       "      <td>1587</td>\n",
       "      <td>450</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>3929</td>\n",
       "      <td>...</td>\n",
       "      <td>123.0</td>\n",
       "      <td>16.731911</td>\n",
       "      <td>407.0</td>\n",
       "      <td>61.227981</td>\n",
       "      <td>295.0</td>\n",
       "      <td>39.519653</td>\n",
       "      <td>858.0</td>\n",
       "      <td>135.117708</td>\n",
       "      <td>1153.0</td>\n",
       "      <td>174.637361</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>2020-03-21</td>\n",
       "      <td>0</td>\n",
       "      <td>5900</td>\n",
       "      <td>1453</td>\n",
       "      <td>1811</td>\n",
       "      <td>525</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>4447</td>\n",
       "      <td>...</td>\n",
       "      <td>75.0</td>\n",
       "      <td>10.289300</td>\n",
       "      <td>224.0</td>\n",
       "      <td>27.720374</td>\n",
       "      <td>156.0</td>\n",
       "      <td>16.336047</td>\n",
       "      <td>518.0</td>\n",
       "      <td>66.450492</td>\n",
       "      <td>674.0</td>\n",
       "      <td>82.786539</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>2020-03-22</td>\n",
       "      <td>0</td>\n",
       "      <td>6954</td>\n",
       "      <td>1674</td>\n",
       "      <td>2117</td>\n",
       "      <td>632</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>5280</td>\n",
       "      <td>...</td>\n",
       "      <td>107.0</td>\n",
       "      <td>18.350434</td>\n",
       "      <td>306.0</td>\n",
       "      <td>53.126913</td>\n",
       "      <td>221.0</td>\n",
       "      <td>24.985433</td>\n",
       "      <td>833.0</td>\n",
       "      <td>93.564924</td>\n",
       "      <td>1054.0</td>\n",
       "      <td>118.550358</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>2020-03-23</td>\n",
       "      <td>0</td>\n",
       "      <td>8673</td>\n",
       "      <td>2080</td>\n",
       "      <td>2567</td>\n",
       "      <td>860</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>6593</td>\n",
       "      <td>...</td>\n",
       "      <td>228.0</td>\n",
       "      <td>34.298674</td>\n",
       "      <td>450.0</td>\n",
       "      <td>58.653930</td>\n",
       "      <td>406.0</td>\n",
       "      <td>45.526578</td>\n",
       "      <td>1313.0</td>\n",
       "      <td>162.335152</td>\n",
       "      <td>1719.0</td>\n",
       "      <td>207.861730</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>2020-03-24</td>\n",
       "      <td>0</td>\n",
       "      <td>10163</td>\n",
       "      <td>2503</td>\n",
       "      <td>3281</td>\n",
       "      <td>1100</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>7660</td>\n",
       "      <td>...</td>\n",
       "      <td>240.0</td>\n",
       "      <td>32.410663</td>\n",
       "      <td>714.0</td>\n",
       "      <td>97.479238</td>\n",
       "      <td>423.0</td>\n",
       "      <td>45.987598</td>\n",
       "      <td>1067.0</td>\n",
       "      <td>129.642993</td>\n",
       "      <td>1490.0</td>\n",
       "      <td>175.630590</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>2020-03-25</td>\n",
       "      <td>0</td>\n",
       "      <td>12072</td>\n",
       "      <td>2935</td>\n",
       "      <td>4085</td>\n",
       "      <td>1388</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>9137</td>\n",
       "      <td>...</td>\n",
       "      <td>288.0</td>\n",
       "      <td>40.367896</td>\n",
       "      <td>804.0</td>\n",
       "      <td>110.570149</td>\n",
       "      <td>432.0</td>\n",
       "      <td>54.647046</td>\n",
       "      <td>1477.0</td>\n",
       "      <td>186.628353</td>\n",
       "      <td>1909.0</td>\n",
       "      <td>241.275399</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>2020-03-26</td>\n",
       "      <td>0</td>\n",
       "      <td>13879</td>\n",
       "      <td>3351</td>\n",
       "      <td>4947</td>\n",
       "      <td>1696</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>10528</td>\n",
       "      <td>...</td>\n",
       "      <td>308.0</td>\n",
       "      <td>39.785457</td>\n",
       "      <td>862.0</td>\n",
       "      <td>111.321907</td>\n",
       "      <td>416.0</td>\n",
       "      <td>54.320334</td>\n",
       "      <td>1391.0</td>\n",
       "      <td>158.384489</td>\n",
       "      <td>1807.0</td>\n",
       "      <td>212.704823</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>2020-03-27</td>\n",
       "      <td>0</td>\n",
       "      <td>15701</td>\n",
       "      <td>3758</td>\n",
       "      <td>5698</td>\n",
       "      <td>1995</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>11943</td>\n",
       "      <td>...</td>\n",
       "      <td>299.0</td>\n",
       "      <td>36.416831</td>\n",
       "      <td>751.0</td>\n",
       "      <td>89.493647</td>\n",
       "      <td>407.0</td>\n",
       "      <td>46.058376</td>\n",
       "      <td>1415.0</td>\n",
       "      <td>171.204902</td>\n",
       "      <td>1822.0</td>\n",
       "      <td>217.263278</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>2020-03-28</td>\n",
       "      <td>0</td>\n",
       "      <td>17580</td>\n",
       "      <td>4236</td>\n",
       "      <td>6624</td>\n",
       "      <td>2314</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>13344</td>\n",
       "      <td>...</td>\n",
       "      <td>319.0</td>\n",
       "      <td>36.915085</td>\n",
       "      <td>926.0</td>\n",
       "      <td>111.808371</td>\n",
       "      <td>478.0</td>\n",
       "      <td>51.364144</td>\n",
       "      <td>1401.0</td>\n",
       "      <td>159.166076</td>\n",
       "      <td>1879.0</td>\n",
       "      <td>210.530220</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>2020-03-29</td>\n",
       "      <td>0</td>\n",
       "      <td>19311</td>\n",
       "      <td>4592</td>\n",
       "      <td>7131</td>\n",
       "      <td>2606</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>14719</td>\n",
       "      <td>...</td>\n",
       "      <td>292.0</td>\n",
       "      <td>33.540852</td>\n",
       "      <td>507.0</td>\n",
       "      <td>64.205188</td>\n",
       "      <td>356.0</td>\n",
       "      <td>42.307977</td>\n",
       "      <td>1375.0</td>\n",
       "      <td>148.372559</td>\n",
       "      <td>1731.0</td>\n",
       "      <td>190.680536</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>2020-03-30</td>\n",
       "      <td>0</td>\n",
       "      <td>20946</td>\n",
       "      <td>5056</td>\n",
       "      <td>7923</td>\n",
       "      <td>3024</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>15890</td>\n",
       "      <td>...</td>\n",
       "      <td>418.0</td>\n",
       "      <td>54.075178</td>\n",
       "      <td>792.0</td>\n",
       "      <td>114.254881</td>\n",
       "      <td>464.0</td>\n",
       "      <td>50.219610</td>\n",
       "      <td>1171.0</td>\n",
       "      <td>137.643224</td>\n",
       "      <td>1635.0</td>\n",
       "      <td>187.862834</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>13</th>\n",
       "      <td>2020-03-31</td>\n",
       "      <td>0</td>\n",
       "      <td>22672</td>\n",
       "      <td>5496</td>\n",
       "      <td>9443</td>\n",
       "      <td>3523</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>17176</td>\n",
       "      <td>...</td>\n",
       "      <td>499.0</td>\n",
       "      <td>55.153783</td>\n",
       "      <td>1520.0</td>\n",
       "      <td>190.517771</td>\n",
       "      <td>440.0</td>\n",
       "      <td>46.464422</td>\n",
       "      <td>1286.0</td>\n",
       "      <td>138.325980</td>\n",
       "      <td>1726.0</td>\n",
       "      <td>184.790403</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>14</th>\n",
       "      <td>2020-04-01</td>\n",
       "      <td>0</td>\n",
       "      <td>24543</td>\n",
       "      <td>5940</td>\n",
       "      <td>10933</td>\n",
       "      <td>4032</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>18603</td>\n",
       "      <td>...</td>\n",
       "      <td>509.0</td>\n",
       "      <td>59.910319</td>\n",
       "      <td>1490.0</td>\n",
       "      <td>169.362447</td>\n",
       "      <td>444.0</td>\n",
       "      <td>48.998882</td>\n",
       "      <td>1427.0</td>\n",
       "      <td>168.557321</td>\n",
       "      <td>1871.0</td>\n",
       "      <td>217.556203</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>15</th>\n",
       "      <td>2020-04-02</td>\n",
       "      <td>0</td>\n",
       "      <td>26122</td>\n",
       "      <td>6302</td>\n",
       "      <td>12425</td>\n",
       "      <td>4501</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>19820</td>\n",
       "      <td>...</td>\n",
       "      <td>469.0</td>\n",
       "      <td>58.876056</td>\n",
       "      <td>1492.0</td>\n",
       "      <td>209.952060</td>\n",
       "      <td>362.0</td>\n",
       "      <td>47.820627</td>\n",
       "      <td>1217.0</td>\n",
       "      <td>123.488708</td>\n",
       "      <td>1579.0</td>\n",
       "      <td>171.309335</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>2020-04-03</td>\n",
       "      <td>0</td>\n",
       "      <td>27284</td>\n",
       "      <td>6553</td>\n",
       "      <td>14005</td>\n",
       "      <td>5089</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>20731</td>\n",
       "      <td>...</td>\n",
       "      <td>588.0</td>\n",
       "      <td>71.514410</td>\n",
       "      <td>1580.0</td>\n",
       "      <td>189.820850</td>\n",
       "      <td>251.0</td>\n",
       "      <td>23.434719</td>\n",
       "      <td>911.0</td>\n",
       "      <td>102.472490</td>\n",
       "      <td>1162.0</td>\n",
       "      <td>125.907209</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>17</th>\n",
       "      <td>2020-04-04</td>\n",
       "      <td>0</td>\n",
       "      <td>27988</td>\n",
       "      <td>6720</td>\n",
       "      <td>15430</td>\n",
       "      <td>5530</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>21268</td>\n",
       "      <td>...</td>\n",
       "      <td>441.0</td>\n",
       "      <td>56.964029</td>\n",
       "      <td>1425.0</td>\n",
       "      <td>180.544954</td>\n",
       "      <td>167.0</td>\n",
       "      <td>19.440706</td>\n",
       "      <td>537.0</td>\n",
       "      <td>64.257296</td>\n",
       "      <td>704.0</td>\n",
       "      <td>83.698002</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>18</th>\n",
       "      <td>2020-04-05</td>\n",
       "      <td>0</td>\n",
       "      <td>28730</td>\n",
       "      <td>6856</td>\n",
       "      <td>16174</td>\n",
       "      <td>5887</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>21874</td>\n",
       "      <td>...</td>\n",
       "      <td>357.0</td>\n",
       "      <td>41.871292</td>\n",
       "      <td>744.0</td>\n",
       "      <td>86.649981</td>\n",
       "      <td>136.0</td>\n",
       "      <td>15.881066</td>\n",
       "      <td>606.0</td>\n",
       "      <td>74.430632</td>\n",
       "      <td>742.0</td>\n",
       "      <td>90.311698</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>19</th>\n",
       "      <td>2020-04-06</td>\n",
       "      <td>0</td>\n",
       "      <td>29553</td>\n",
       "      <td>6945</td>\n",
       "      <td>17236</td>\n",
       "      <td>6492</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>22608</td>\n",
       "      <td>...</td>\n",
       "      <td>605.0</td>\n",
       "      <td>75.339322</td>\n",
       "      <td>1062.0</td>\n",
       "      <td>122.162697</td>\n",
       "      <td>89.0</td>\n",
       "      <td>8.906297</td>\n",
       "      <td>734.0</td>\n",
       "      <td>94.853574</td>\n",
       "      <td>823.0</td>\n",
       "      <td>103.759871</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>20</th>\n",
       "      <td>2020-04-07</td>\n",
       "      <td>0</td>\n",
       "      <td>29855</td>\n",
       "      <td>7001</td>\n",
       "      <td>19319</td>\n",
       "      <td>7089</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>22854</td>\n",
       "      <td>...</td>\n",
       "      <td>597.0</td>\n",
       "      <td>68.517764</td>\n",
       "      <td>2083.0</td>\n",
       "      <td>268.353805</td>\n",
       "      <td>56.0</td>\n",
       "      <td>7.196777</td>\n",
       "      <td>246.0</td>\n",
       "      <td>19.092315</td>\n",
       "      <td>302.0</td>\n",
       "      <td>26.289092</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>21</th>\n",
       "      <td>2020-04-08</td>\n",
       "      <td>0</td>\n",
       "      <td>30202</td>\n",
       "      <td>7015</td>\n",
       "      <td>21228</td>\n",
       "      <td>7630</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>23187</td>\n",
       "      <td>...</td>\n",
       "      <td>541.0</td>\n",
       "      <td>62.772638</td>\n",
       "      <td>1909.0</td>\n",
       "      <td>225.133792</td>\n",
       "      <td>14.0</td>\n",
       "      <td>-2.551751</td>\n",
       "      <td>333.0</td>\n",
       "      <td>28.736665</td>\n",
       "      <td>347.0</td>\n",
       "      <td>26.184913</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>22</th>\n",
       "      <td>2020-04-09</td>\n",
       "      <td>0</td>\n",
       "      <td>30592</td>\n",
       "      <td>6933</td>\n",
       "      <td>23179</td>\n",
       "      <td>8042</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>23659</td>\n",
       "      <td>...</td>\n",
       "      <td>412.0</td>\n",
       "      <td>46.698045</td>\n",
       "      <td>1951.0</td>\n",
       "      <td>235.733023</td>\n",
       "      <td>-82.0</td>\n",
       "      <td>-9.059206</td>\n",
       "      <td>472.0</td>\n",
       "      <td>55.535138</td>\n",
       "      <td>390.0</td>\n",
       "      <td>46.475932</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>23</th>\n",
       "      <td>2020-04-10</td>\n",
       "      <td>0</td>\n",
       "      <td>31088</td>\n",
       "      <td>6871</td>\n",
       "      <td>24907</td>\n",
       "      <td>8596</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>24217</td>\n",
       "      <td>...</td>\n",
       "      <td>554.0</td>\n",
       "      <td>63.941513</td>\n",
       "      <td>1728.0</td>\n",
       "      <td>229.436846</td>\n",
       "      <td>-62.0</td>\n",
       "      <td>-10.149857</td>\n",
       "      <td>558.0</td>\n",
       "      <td>65.092823</td>\n",
       "      <td>496.0</td>\n",
       "      <td>54.942967</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>24</th>\n",
       "      <td>2020-04-11</td>\n",
       "      <td>0</td>\n",
       "      <td>31139</td>\n",
       "      <td>6749</td>\n",
       "      <td>26365</td>\n",
       "      <td>8940</td>\n",
       "      <td>5312.0</td>\n",
       "      <td>548020767</td>\n",
       "      <td>67609086</td>\n",
       "      <td>24390</td>\n",
       "      <td>...</td>\n",
       "      <td>344.0</td>\n",
       "      <td>43.961864</td>\n",
       "      <td>1458.0</td>\n",
       "      <td>183.708246</td>\n",
       "      <td>-122.0</td>\n",
       "      <td>-14.245983</td>\n",
       "      <td>173.0</td>\n",
       "      <td>2.842367</td>\n",
       "      <td>51.0</td>\n",
       "      <td>-11.403615</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>25 rows × 27 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "          jour  sexe   hosp   rea    rad    dc  regionCode  regionPopulation  \\\n",
       "0   2020-03-18     0   2972   771    816   218      5312.0         548020767   \n",
       "1   2020-03-19     0   4073  1002   1180   327      5312.0         548020767   \n",
       "2   2020-03-20     0   5226  1297   1587   450      5312.0         548020767   \n",
       "3   2020-03-21     0   5900  1453   1811   525      5312.0         548020767   \n",
       "4   2020-03-22     0   6954  1674   2117   632      5312.0         548020767   \n",
       "5   2020-03-23     0   8673  2080   2567   860      5312.0         548020767   \n",
       "6   2020-03-24     0  10163  2503   3281  1100      5312.0         548020767   \n",
       "7   2020-03-25     0  12072  2935   4085  1388      5312.0         548020767   \n",
       "8   2020-03-26     0  13879  3351   4947  1696      5312.0         548020767   \n",
       "9   2020-03-27     0  15701  3758   5698  1995      5312.0         548020767   \n",
       "10  2020-03-28     0  17580  4236   6624  2314      5312.0         548020767   \n",
       "11  2020-03-29     0  19311  4592   7131  2606      5312.0         548020767   \n",
       "12  2020-03-30     0  20946  5056   7923  3024      5312.0         548020767   \n",
       "13  2020-03-31     0  22672  5496   9443  3523      5312.0         548020767   \n",
       "14  2020-04-01     0  24543  5940  10933  4032      5312.0         548020767   \n",
       "15  2020-04-02     0  26122  6302  12425  4501      5312.0         548020767   \n",
       "16  2020-04-03     0  27284  6553  14005  5089      5312.0         548020767   \n",
       "17  2020-04-04     0  27988  6720  15430  5530      5312.0         548020767   \n",
       "18  2020-04-05     0  28730  6856  16174  5887      5312.0         548020767   \n",
       "19  2020-04-06     0  29553  6945  17236  6492      5312.0         548020767   \n",
       "20  2020-04-07     0  29855  7001  19319  7089      5312.0         548020767   \n",
       "21  2020-04-08     0  30202  7015  21228  7630      5312.0         548020767   \n",
       "22  2020-04-09     0  30592  6933  23179  8042      5312.0         548020767   \n",
       "23  2020-04-10     0  31088  6871  24907  8596      5312.0         548020767   \n",
       "24  2020-04-11     0  31139  6749  26365  8940      5312.0         548020767   \n",
       "\n",
       "    departmentPopulation  hosp_nonrea  ...  dc_new  dc_new_deppop  rad_new  \\\n",
       "0               67609086         2201  ...     0.0       0.000000      0.0   \n",
       "1               67609086         3071  ...   109.0      15.396317    364.0   \n",
       "2               67609086         3929  ...   123.0      16.731911    407.0   \n",
       "3               67609086         4447  ...    75.0      10.289300    224.0   \n",
       "4               67609086         5280  ...   107.0      18.350434    306.0   \n",
       "5               67609086         6593  ...   228.0      34.298674    450.0   \n",
       "6               67609086         7660  ...   240.0      32.410663    714.0   \n",
       "7               67609086         9137  ...   288.0      40.367896    804.0   \n",
       "8               67609086        10528  ...   308.0      39.785457    862.0   \n",
       "9               67609086        11943  ...   299.0      36.416831    751.0   \n",
       "10              67609086        13344  ...   319.0      36.915085    926.0   \n",
       "11              67609086        14719  ...   292.0      33.540852    507.0   \n",
       "12              67609086        15890  ...   418.0      54.075178    792.0   \n",
       "13              67609086        17176  ...   499.0      55.153783   1520.0   \n",
       "14              67609086        18603  ...   509.0      59.910319   1490.0   \n",
       "15              67609086        19820  ...   469.0      58.876056   1492.0   \n",
       "16              67609086        20731  ...   588.0      71.514410   1580.0   \n",
       "17              67609086        21268  ...   441.0      56.964029   1425.0   \n",
       "18              67609086        21874  ...   357.0      41.871292    744.0   \n",
       "19              67609086        22608  ...   605.0      75.339322   1062.0   \n",
       "20              67609086        22854  ...   597.0      68.517764   2083.0   \n",
       "21              67609086        23187  ...   541.0      62.772638   1909.0   \n",
       "22              67609086        23659  ...   412.0      46.698045   1951.0   \n",
       "23              67609086        24217  ...   554.0      63.941513   1728.0   \n",
       "24              67609086        24390  ...   344.0      43.961864   1458.0   \n",
       "\n",
       "    rad_new_deppop  rea_new  rea_new_deppop  hosp_nonrea_new  \\\n",
       "0         0.000000      0.0        0.000000              0.0   \n",
       "1        40.116786    231.0       23.731770            870.0   \n",
       "2        61.227981    295.0       39.519653            858.0   \n",
       "3        27.720374    156.0       16.336047            518.0   \n",
       "4        53.126913    221.0       24.985433            833.0   \n",
       "5        58.653930    406.0       45.526578           1313.0   \n",
       "6        97.479238    423.0       45.987598           1067.0   \n",
       "7       110.570149    432.0       54.647046           1477.0   \n",
       "8       111.321907    416.0       54.320334           1391.0   \n",
       "9        89.493647    407.0       46.058376           1415.0   \n",
       "10      111.808371    478.0       51.364144           1401.0   \n",
       "11       64.205188    356.0       42.307977           1375.0   \n",
       "12      114.254881    464.0       50.219610           1171.0   \n",
       "13      190.517771    440.0       46.464422           1286.0   \n",
       "14      169.362447    444.0       48.998882           1427.0   \n",
       "15      209.952060    362.0       47.820627           1217.0   \n",
       "16      189.820850    251.0       23.434719            911.0   \n",
       "17      180.544954    167.0       19.440706            537.0   \n",
       "18       86.649981    136.0       15.881066            606.0   \n",
       "19      122.162697     89.0        8.906297            734.0   \n",
       "20      268.353805     56.0        7.196777            246.0   \n",
       "21      225.133792     14.0       -2.551751            333.0   \n",
       "22      235.733023    -82.0       -9.059206            472.0   \n",
       "23      229.436846    -62.0      -10.149857            558.0   \n",
       "24      183.708246   -122.0      -14.245983            173.0   \n",
       "\n",
       "    hosp_nonrea_new_deppop  hosp_new  hosp_new_deppop  \n",
       "0                 0.000000       0.0         0.000000  \n",
       "1                95.763670    1101.0       119.495440  \n",
       "2               135.117708    1153.0       174.637361  \n",
       "3                66.450492     674.0        82.786539  \n",
       "4                93.564924    1054.0       118.550358  \n",
       "5               162.335152    1719.0       207.861730  \n",
       "6               129.642993    1490.0       175.630590  \n",
       "7               186.628353    1909.0       241.275399  \n",
       "8               158.384489    1807.0       212.704823  \n",
       "9               171.204902    1822.0       217.263278  \n",
       "10              159.166076    1879.0       210.530220  \n",
       "11              148.372559    1731.0       190.680536  \n",
       "12              137.643224    1635.0       187.862834  \n",
       "13              138.325980    1726.0       184.790403  \n",
       "14              168.557321    1871.0       217.556203  \n",
       "15              123.488708    1579.0       171.309335  \n",
       "16              102.472490    1162.0       125.907209  \n",
       "17               64.257296     704.0        83.698002  \n",
       "18               74.430632     742.0        90.311698  \n",
       "19               94.853574     823.0       103.759871  \n",
       "20               19.092315     302.0        26.289092  \n",
       "21               28.736665     347.0        26.184913  \n",
       "22               55.535138     390.0        46.475932  \n",
       "23               65.092823     496.0        54.942967  \n",
       "24                2.842367      51.0       -11.403615  \n",
       "\n",
       "[25 rows x 27 columns]"
      ]
     },
     "execution_count": 881,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_france"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 882,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_new_tot = pd.melt(df_new, id_vars=['jour'], value_vars=['incid_rad', 'incid_rea', 'incid_dc', 'incid_hosp'])\n",
    "df_new_tot = df_new.groupby([\"jour\"]).sum().reset_index()\n",
    "\n",
    "last_row = df_new_tot.iloc[-1]\n",
    "df_new_tot = df_new_tot.shift()\n",
    "df_new_tot = df_new_tot.append(last_row, ignore_index=True)\n",
    "\n",
    "#Calcul sorties de réa\n",
    "df_new_tot[\"incid_dep_rea\"] = df_france[\"rea\"] - df_france[\"rea\"].shift() - df_new_tot[\"incid_rea\"]\n",
    "df_new_tot[\"incid_dep_hosp_nonrea\"] = df_france[\"hosp_nonrea\"] - df_france[\"hosp_nonrea\"].shift() - df_new_tot[\"incid_hosp_nonrea\"]\n",
    "\n",
    "df_new_tot_last15 = df_new_tot[ df_new_tot[\"jour\"].isin(dates[-19:]) ]\n",
    "df_france_last15 = df_france[ df_france[\"jour\"].isin(dates[-19:]) ]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 883,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_new_tot = pd.melt(df, id_vars=['jour'], value_vars=['rad_new', 'rea_new', 'dc_new', 'hosp_new'])\n",
    "df_new_tot = df_new.groupby([\"jour\"]).sum().reset_index()\n",
    "\n",
    "last_row = df_new_tot.iloc[-1]\n",
    "df_new_tot = df_new_tot.shift()\n",
    "df_new_tot = df_new_tot.append(last_row, ignore_index=True)\n",
    "\n",
    "#Calcul sorties de réa\n",
    "df_new_tot[\"incid_dep_rea\"] = df_france[\"rea\"] - df_france[\"rea\"].shift() - df_new_tot[\"incid_rea\"]\n",
    "df_new_tot[\"incid_dep_hosp_nonrea\"] = df_france[\"hosp_nonrea\"] - df_france[\"hosp_nonrea\"].shift() - df_new_tot[\"incid_hosp_nonrea\"]\n",
    "\n",
    "df_new_tot_last15 = df_new_tot[ df_new_tot[\"jour\"].isin(dates[-19:]) ]\n",
    "df_france_last15 = df_france[ df_france[\"jour\"].isin(dates[-19:]) ]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 884,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "> entrees_sorties_hosp_rea\n"
     ]
    }
   ],
   "source": [
    "fig = go.Figure()\n",
    "#fig = make_subplots(specs=[[{\"secondary_y\": True}]])\n",
    "fig.add_trace(go.Bar(\n",
    "    x = df_new_tot_last15[\"jour\"],\n",
    "    y = df_new_tot_last15[\"incid_rea\"],\n",
    "    name = \"Admissions réanimation\",\n",
    "    marker_color='red',\n",
    "    opacity=0.8\n",
    "))\n",
    "\n",
    "fig.add_trace(go.Bar(\n",
    "    x = df_new_tot_last15[\"jour\"],\n",
    "    y = df_new_tot_last15[\"incid_hosp_nonrea\"],\n",
    "    name = \"Admissions autre hispitalisation\",\n",
    "    marker_color='red',\n",
    "    opacity=0.5\n",
    "))\n",
    "\n",
    "fig.add_trace(go.Bar(\n",
    "    x = df_new_tot_last15[\"jour\"],\n",
    "    y = df_new_tot_last15[\"incid_dep_rea\"],\n",
    "    name = \"Sorties réanimation\",\n",
    "    marker_color='green',\n",
    "    opacity=0.8\n",
    "))\n",
    "\n",
    "fig.add_trace(go.Bar(\n",
    "    x = df_new_tot_last15[\"jour\"],\n",
    "    y = df_new_tot_last15[\"incid_dep_hosp_nonrea\"],\n",
    "    name = \"Sorties autre hospitalisation\",\n",
    "    marker_color='green',\n",
    "    opacity=0.5\n",
    "))\n",
    "\n",
    "fig.add_trace(go.Scatter(\n",
    "    x = df_france[\"jour\"],\n",
    "    y = df_france[\"rea_new\"],\n",
    "    name = \"Bilan réa\",\n",
    "    marker_color='black',\n",
    "    mode=\"lines+markers\",\n",
    "    opacity=0.8\n",
    "))\n",
    "\n",
    "fig.add_trace(go.Scatter(\n",
    "    x = df_france[\"jour\"],\n",
    "    y = df_france[\"hosp_nonrea_new\"],\n",
    "    name = \"Bilan autre hosp\",\n",
    "    marker_color='black',\n",
    "    mode=\"lines+markers\",\n",
    "    opacity=0.4\n",
    "))\n",
    "\n",
    "\n",
    "# Here we modify the tickangle of the xaxis, resulting in rotated labels.\n",
    "fig.update_layout(\n",
    "    legend_orientation=\"v\",\n",
    "    barmode='relative',\n",
    "    title={\n",
    "                'text': \"<b>COVID-19 : entrées et sorties en hospitalisation</b>\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "                titlefont = dict(\n",
    "                size=20),\n",
    "    xaxis=dict(\n",
    "        title='',\n",
    "        tickformat='%d/%m'),\n",
    "    yaxis_title=\"Nb. de personnes\",\n",
    "    \n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "\n",
    "name_fig = \"entrees_sorties_hosp_rea\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=2, width=1200, height=800)\n",
    "\n",
    "fig.update_layout(\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0.5,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    xanchor='center',\n",
    "                    text='Cliquez sur des éléments de légende pour les ajouter/supprimer',\n",
    "                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 885,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "> evol_journ\n"
     ]
    }
   ],
   "source": [
    "fig = go.Figure()\n",
    "\n",
    "fig.add_trace(go.Bar(\n",
    "    x = df_new_tot_last15[\"jour\"],\n",
    "    y = df_new_tot_last15[\"incid_dc\"],\n",
    "    name = \"Nouveaux décès hosp.\",\n",
    "    marker_color='black',\n",
    "    opacity=0.6\n",
    "))\n",
    "\n",
    "fig.add_trace(go.Bar(\n",
    "    x = df_new_tot_last15[\"jour\"],\n",
    "    y = df_new_tot_last15[\"incid_rea\"],\n",
    "    name = \"<b>Admissions</b> réanimations\",\n",
    "    marker_color='red',\n",
    "    opacity=0.6\n",
    "))\n",
    "\n",
    "fig.add_trace(go.Bar(\n",
    "    x = df_new_tot_last15[\"jour\"],\n",
    "    y = df_new_tot_last15[\"incid_hosp_nonrea\"],\n",
    "    name = \"<b>Admissions</b> autres hospit.\",\n",
    "    marker_color='grey',\n",
    "    opacity=0.6\n",
    "))\n",
    "\n",
    "fig.add_trace(go.Bar(\n",
    "    x = df_new_tot_last15[\"jour\"],\n",
    "    y = df_new_tot_last15[\"incid_rad\"],\n",
    "    name = \"Nouv. retours à domicile\",\n",
    "    marker_color='green',\n",
    "    opacity=0.6\n",
    "))\n",
    "\n",
    "# Here we modify the tickangle of the xaxis, resulting in rotated labels.\n",
    "fig.update_layout(\n",
    "    barmode='group',\n",
    "    title={\n",
    "                'text': \"<b>COVID-19 : évolution quotidienne en France</b>\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "                titlefont = dict(\n",
    "                size=20),\n",
    "    xaxis=dict(\n",
    "        title='',\n",
    "        tickformat='%d/%m',\n",
    "        nticks=100),\n",
    "    yaxis_title=\"Nb. de personnes\",\n",
    "    \n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "\n",
    "name_fig = \"evol_journ\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1400, height=800)\n",
    "\n",
    "fig.update_layout(\n",
    "    legend_orientation=\"h\",\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0.5,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    xanchor='center',\n",
    "                    text='Cliquez sur des éléments de légende pour les ajouter/supprimer',\n",
    "                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 886,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "> hosp_bar\n"
     ]
    }
   ],
   "source": [
    "fig = go.Figure()\n",
    "\n",
    "fig.add_trace(go.Bar(\n",
    "    x = df_france[\"jour\"],\n",
    "    y = df_france[\"hosp\"],\n",
    "    name = \"Hospitalisations\",\n",
    "    opacity=0.6\n",
    "))\n",
    "\n",
    "fig = px.bar(df_france, x='jour', y='hosp',\n",
    "             color='hosp_new',\n",
    "             labels={'hosp_new':'Solde hospitalisations'}, color_continuous_scale=[\"green\", \"#ffc832\", \"#cf0000\"], range_color=(-2500, 2500))\n",
    "\n",
    "# Here we modify the tickangle of the xaxis, resulting in rotated labels.\n",
    "fig.update_layout(\n",
    "    barmode='group',\n",
    "    bargap=0,\n",
    "    yaxis=dict(\n",
    "        range=[0, 45000]),\n",
    "    title={\n",
    "                'text': \"COVID19 : <b>nombre de personnes hospitalisées</b>\",\n",
    "                'y':0.97,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "                titlefont = dict(\n",
    "                size=30),\n",
    "    xaxis=dict(\n",
    "        range=[\"2020-03-15\", \"2020-04-25\"],\n",
    "        title='',\n",
    "        tickformat='%d/%m',\n",
    "        nticks=50\n",
    "    ),\n",
    "    yaxis_title=\"Nb. de personnes\",\n",
    "    \n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0.01,\n",
    "                    y=0.99,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "\n",
    "name_fig = \"hosp_bar\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1400, height=800)\n",
    "\n",
    "fig.update_layout(\n",
    "    legend_orientation=\"h\",\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0.5,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    xanchor='center',\n",
    "                    text='Cliquez sur des éléments de légende pour les ajouter/supprimer',\n",
    "                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 887,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>regionName</th>\n",
       "      <th>jour</th>\n",
       "      <th>regionPopulation</th>\n",
       "      <th>sexe</th>\n",
       "      <th>hosp</th>\n",
       "      <th>rea</th>\n",
       "      <th>rad</th>\n",
       "      <th>dc</th>\n",
       "      <th>regionCode</th>\n",
       "      <th>departmentPopulation</th>\n",
       "      <th>...</th>\n",
       "      <th>dc_new_deppop</th>\n",
       "      <th>rad_new</th>\n",
       "      <th>rad_new_deppop</th>\n",
       "      <th>rea_new</th>\n",
       "      <th>rea_new_deppop</th>\n",
       "      <th>hosp_nonrea_new</th>\n",
       "      <th>hosp_nonrea_new_deppop</th>\n",
       "      <th>hosp_new</th>\n",
       "      <th>hosp_new_deppop</th>\n",
       "      <th>hosp_regpop</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>Auvergne-Rhône-Alpes</td>\n",
       "      <td>2020-03-18</td>\n",
       "      <td>8032377</td>\n",
       "      <td>0</td>\n",
       "      <td>172</td>\n",
       "      <td>35</td>\n",
       "      <td>69</td>\n",
       "      <td>7</td>\n",
       "      <td>1008.0</td>\n",
       "      <td>8069287</td>\n",
       "      <td>...</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>21.413338</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>Auvergne-Rhône-Alpes</td>\n",
       "      <td>2020-03-19</td>\n",
       "      <td>8032377</td>\n",
       "      <td>0</td>\n",
       "      <td>385</td>\n",
       "      <td>79</td>\n",
       "      <td>132</td>\n",
       "      <td>22</td>\n",
       "      <td>1008.0</td>\n",
       "      <td>8069287</td>\n",
       "      <td>...</td>\n",
       "      <td>1.028124</td>\n",
       "      <td>63.0</td>\n",
       "      <td>6.360343</td>\n",
       "      <td>44.0</td>\n",
       "      <td>4.505551</td>\n",
       "      <td>169.0</td>\n",
       "      <td>10.540086</td>\n",
       "      <td>213.0</td>\n",
       "      <td>15.045638</td>\n",
       "      <td>47.931017</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>Auvergne-Rhône-Alpes</td>\n",
       "      <td>2020-03-20</td>\n",
       "      <td>8032377</td>\n",
       "      <td>0</td>\n",
       "      <td>463</td>\n",
       "      <td>87</td>\n",
       "      <td>179</td>\n",
       "      <td>33</td>\n",
       "      <td>1008.0</td>\n",
       "      <td>8069287</td>\n",
       "      <td>...</td>\n",
       "      <td>1.191597</td>\n",
       "      <td>47.0</td>\n",
       "      <td>5.856239</td>\n",
       "      <td>8.0</td>\n",
       "      <td>0.976739</td>\n",
       "      <td>70.0</td>\n",
       "      <td>9.387918</td>\n",
       "      <td>78.0</td>\n",
       "      <td>10.364657</td>\n",
       "      <td>57.641717</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>Auvergne-Rhône-Alpes</td>\n",
       "      <td>2020-03-21</td>\n",
       "      <td>8032377</td>\n",
       "      <td>0</td>\n",
       "      <td>525</td>\n",
       "      <td>88</td>\n",
       "      <td>192</td>\n",
       "      <td>38</td>\n",
       "      <td>1008.0</td>\n",
       "      <td>8069287</td>\n",
       "      <td>...</td>\n",
       "      <td>0.488168</td>\n",
       "      <td>13.0</td>\n",
       "      <td>1.301100</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.128870</td>\n",
       "      <td>61.0</td>\n",
       "      <td>7.226577</td>\n",
       "      <td>62.0</td>\n",
       "      <td>7.355447</td>\n",
       "      <td>65.360478</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>Auvergne-Rhône-Alpes</td>\n",
       "      <td>2020-03-22</td>\n",
       "      <td>8032377</td>\n",
       "      <td>0</td>\n",
       "      <td>641</td>\n",
       "      <td>106</td>\n",
       "      <td>212</td>\n",
       "      <td>47</td>\n",
       "      <td>1008.0</td>\n",
       "      <td>8069287</td>\n",
       "      <td>...</td>\n",
       "      <td>0.912878</td>\n",
       "      <td>20.0</td>\n",
       "      <td>2.248054</td>\n",
       "      <td>18.0</td>\n",
       "      <td>1.956948</td>\n",
       "      <td>98.0</td>\n",
       "      <td>10.755265</td>\n",
       "      <td>116.0</td>\n",
       "      <td>12.712213</td>\n",
       "      <td>79.802031</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>420</th>\n",
       "      <td>Provence-Alpes-Côte d'Azur</td>\n",
       "      <td>2020-04-07</td>\n",
       "      <td>5055651</td>\n",
       "      <td>0</td>\n",
       "      <td>1738</td>\n",
       "      <td>434</td>\n",
       "      <td>1574</td>\n",
       "      <td>253</td>\n",
       "      <td>558.0</td>\n",
       "      <td>5091003</td>\n",
       "      <td>...</td>\n",
       "      <td>1.342500</td>\n",
       "      <td>191.0</td>\n",
       "      <td>17.810798</td>\n",
       "      <td>-6.0</td>\n",
       "      <td>-1.271851</td>\n",
       "      <td>-83.0</td>\n",
       "      <td>-5.390428</td>\n",
       "      <td>-89.0</td>\n",
       "      <td>-6.662279</td>\n",
       "      <td>343.773730</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>421</th>\n",
       "      <td>Provence-Alpes-Côte d'Azur</td>\n",
       "      <td>2020-04-08</td>\n",
       "      <td>5055651</td>\n",
       "      <td>0</td>\n",
       "      <td>1796</td>\n",
       "      <td>437</td>\n",
       "      <td>1684</td>\n",
       "      <td>269</td>\n",
       "      <td>558.0</td>\n",
       "      <td>5091003</td>\n",
       "      <td>...</td>\n",
       "      <td>1.410214</td>\n",
       "      <td>110.0</td>\n",
       "      <td>12.357285</td>\n",
       "      <td>3.0</td>\n",
       "      <td>-0.587002</td>\n",
       "      <td>55.0</td>\n",
       "      <td>2.936433</td>\n",
       "      <td>58.0</td>\n",
       "      <td>2.349431</td>\n",
       "      <td>355.246041</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>422</th>\n",
       "      <td>Provence-Alpes-Côte d'Azur</td>\n",
       "      <td>2020-04-09</td>\n",
       "      <td>5055651</td>\n",
       "      <td>0</td>\n",
       "      <td>1748</td>\n",
       "      <td>426</td>\n",
       "      <td>1841</td>\n",
       "      <td>286</td>\n",
       "      <td>558.0</td>\n",
       "      <td>5091003</td>\n",
       "      <td>...</td>\n",
       "      <td>1.132139</td>\n",
       "      <td>157.0</td>\n",
       "      <td>14.415530</td>\n",
       "      <td>-11.0</td>\n",
       "      <td>-1.553578</td>\n",
       "      <td>-37.0</td>\n",
       "      <td>-3.483429</td>\n",
       "      <td>-48.0</td>\n",
       "      <td>-5.037007</td>\n",
       "      <td>345.751714</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>423</th>\n",
       "      <td>Provence-Alpes-Côte d'Azur</td>\n",
       "      <td>2020-04-10</td>\n",
       "      <td>5055651</td>\n",
       "      <td>0</td>\n",
       "      <td>1804</td>\n",
       "      <td>441</td>\n",
       "      <td>1946</td>\n",
       "      <td>299</td>\n",
       "      <td>558.0</td>\n",
       "      <td>5091003</td>\n",
       "      <td>...</td>\n",
       "      <td>1.108143</td>\n",
       "      <td>105.0</td>\n",
       "      <td>11.197691</td>\n",
       "      <td>15.0</td>\n",
       "      <td>0.981044</td>\n",
       "      <td>41.0</td>\n",
       "      <td>2.693134</td>\n",
       "      <td>56.0</td>\n",
       "      <td>3.674178</td>\n",
       "      <td>356.828428</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>424</th>\n",
       "      <td>Provence-Alpes-Côte d'Azur</td>\n",
       "      <td>2020-04-11</td>\n",
       "      <td>5055651</td>\n",
       "      <td>0</td>\n",
       "      <td>1766</td>\n",
       "      <td>436</td>\n",
       "      <td>2053</td>\n",
       "      <td>317</td>\n",
       "      <td>558.0</td>\n",
       "      <td>5091003</td>\n",
       "      <td>...</td>\n",
       "      <td>1.093907</td>\n",
       "      <td>107.0</td>\n",
       "      <td>11.582818</td>\n",
       "      <td>-5.0</td>\n",
       "      <td>0.101043</td>\n",
       "      <td>-33.0</td>\n",
       "      <td>-4.103706</td>\n",
       "      <td>-38.0</td>\n",
       "      <td>-4.002663</td>\n",
       "      <td>349.312087</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>425 rows × 29 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "                     regionName        jour  regionPopulation  sexe  hosp  \\\n",
       "0          Auvergne-Rhône-Alpes  2020-03-18           8032377     0   172   \n",
       "1          Auvergne-Rhône-Alpes  2020-03-19           8032377     0   385   \n",
       "2          Auvergne-Rhône-Alpes  2020-03-20           8032377     0   463   \n",
       "3          Auvergne-Rhône-Alpes  2020-03-21           8032377     0   525   \n",
       "4          Auvergne-Rhône-Alpes  2020-03-22           8032377     0   641   \n",
       "..                          ...         ...               ...   ...   ...   \n",
       "420  Provence-Alpes-Côte d'Azur  2020-04-07           5055651     0  1738   \n",
       "421  Provence-Alpes-Côte d'Azur  2020-04-08           5055651     0  1796   \n",
       "422  Provence-Alpes-Côte d'Azur  2020-04-09           5055651     0  1748   \n",
       "423  Provence-Alpes-Côte d'Azur  2020-04-10           5055651     0  1804   \n",
       "424  Provence-Alpes-Côte d'Azur  2020-04-11           5055651     0  1766   \n",
       "\n",
       "     rea   rad   dc  regionCode  departmentPopulation  ...  dc_new_deppop  \\\n",
       "0     35    69    7      1008.0               8069287  ...       0.000000   \n",
       "1     79   132   22      1008.0               8069287  ...       1.028124   \n",
       "2     87   179   33      1008.0               8069287  ...       1.191597   \n",
       "3     88   192   38      1008.0               8069287  ...       0.488168   \n",
       "4    106   212   47      1008.0               8069287  ...       0.912878   \n",
       "..   ...   ...  ...         ...                   ...  ...            ...   \n",
       "420  434  1574  253       558.0               5091003  ...       1.342500   \n",
       "421  437  1684  269       558.0               5091003  ...       1.410214   \n",
       "422  426  1841  286       558.0               5091003  ...       1.132139   \n",
       "423  441  1946  299       558.0               5091003  ...       1.108143   \n",
       "424  436  2053  317       558.0               5091003  ...       1.093907   \n",
       "\n",
       "     rad_new  rad_new_deppop  rea_new  rea_new_deppop  hosp_nonrea_new  \\\n",
       "0        0.0        0.000000      0.0        0.000000              0.0   \n",
       "1       63.0        6.360343     44.0        4.505551            169.0   \n",
       "2       47.0        5.856239      8.0        0.976739             70.0   \n",
       "3       13.0        1.301100      1.0        0.128870             61.0   \n",
       "4       20.0        2.248054     18.0        1.956948             98.0   \n",
       "..       ...             ...      ...             ...              ...   \n",
       "420    191.0       17.810798     -6.0       -1.271851            -83.0   \n",
       "421    110.0       12.357285      3.0       -0.587002             55.0   \n",
       "422    157.0       14.415530    -11.0       -1.553578            -37.0   \n",
       "423    105.0       11.197691     15.0        0.981044             41.0   \n",
       "424    107.0       11.582818     -5.0        0.101043            -33.0   \n",
       "\n",
       "     hosp_nonrea_new_deppop  hosp_new  hosp_new_deppop  hosp_regpop  \n",
       "0                  0.000000       0.0         0.000000    21.413338  \n",
       "1                 10.540086     213.0        15.045638    47.931017  \n",
       "2                  9.387918      78.0        10.364657    57.641717  \n",
       "3                  7.226577      62.0         7.355447    65.360478  \n",
       "4                 10.755265     116.0        12.712213    79.802031  \n",
       "..                      ...       ...              ...          ...  \n",
       "420               -5.390428     -89.0        -6.662279   343.773730  \n",
       "421                2.936433      58.0         2.349431   355.246041  \n",
       "422               -3.483429     -48.0        -5.037007   345.751714  \n",
       "423                2.693134      56.0         3.674178   356.828428  \n",
       "424               -4.103706     -38.0        -4.002663   349.312087  \n",
       "\n",
       "[425 rows x 29 columns]"
      ]
     },
     "execution_count": 887,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_region"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 892,
   "metadata": {
    "scrolled": false
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/Users/guillaumerozier/opt/anaconda3/lib/python3.7/site-packages/ipykernel_launcher.py:16: SettingWithCopyWarning:\n",
      "\n",
      "\n",
      "A value is trying to be set on a copy of a slice from a DataFrame.\n",
      "Try using .loc[row_indexer,col_indexer] = value instead\n",
      "\n",
      "See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n",
      "\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "> subplots_hosp\n",
      "> subplots_hosp_regpop\n"
     ]
    }
   ],
   "source": [
    "\n",
    "for val in [\"hosp\", \"hosp_regpop\"]:\n",
    "    ni, nj = 5, 4\n",
    "    i, j = 1, 1\n",
    "\n",
    "    df_region[val+\"_new\"] = df_region[val].diff()\n",
    "    max_value = df_region[val].max()\n",
    "    \n",
    "    regions_ordered = df_region[df_region['jour'] == dates[-1]].sort_values(by=[val], ascending=False)[\"regionName\"].values\n",
    "    regions_ordered = list(dict.fromkeys(list(regions_ordered)))[:]\n",
    "    \n",
    "    fig = make_subplots(rows=ni, cols=nj, shared_yaxes=True, subplot_titles=[ \"<b>\"+ str(r) +\"</b>\" for r in (regions_ordered[:11] + [\"\"] + regions_ordered[11:14]+[\"\"]+regions_ordered[14:])], vertical_spacing = 0.05, horizontal_spacing = 0.01)\n",
    "\n",
    "    for region in regions_ordered:\n",
    "        data_r = df_region[df_region[\"regionName\"] == region]\n",
    "        \n",
    "        data_r[val + \"_new\"] = data_r[val].diff()\n",
    "        ordered_values = df_region.sort_values(by=[val + \"_new\"], ascending=False)[val + \"_new\"]\n",
    "        max_value_diff = ordered_values.quantile(.90)\n",
    "        \n",
    "        fig.add_trace(go.Bar(x=data_r[\"jour\"], y=data_r[val],\n",
    "                            marker=dict(color = data_r[val + \"_new\"], coloraxis=\"coloraxis\"), ),\n",
    "                      i, j)\n",
    "\n",
    "        fig.update_xaxes(title_text=\"\", range=[\"2020-03-15\", \"2020-05-01\"], gridcolor='#ffffff', tickformat='%d/%m', tickangle=0, nticks=10, row=i, col=j)\n",
    "        fig.update_yaxes(title_text=\"\", range=[0, max_value], gridcolor='#ffffff', row=i, col=j)\n",
    "\n",
    "        j+=1\n",
    "        if j == nj+1 or ((i >= 3) & (j == nj)):\n",
    "            i+=1\n",
    "            j=1\n",
    "            \n",
    "        \"\"\"if j == nj+1:\n",
    "            i+=1\n",
    "            j=1\"\"\"\n",
    "\n",
    "    for i in fig['layout']['annotations']:\n",
    "        i['font'] = dict(size=15)\n",
    "\n",
    "    #for annotation in fig['layout']['annotations']: \n",
    "            #annotation ['x'] = 0.5\n",
    "    by_million_title = \"\"\n",
    "    by_million_legend = \"\"\n",
    "    if \"pop\" in val:\n",
    "        by_million_title = \" pour 1M. hab.\"\n",
    "        by_million_legend = \"<br>pour 1M. d'hab.\"\n",
    "\n",
    "    fig.update_layout(\n",
    "        margin=dict(\n",
    "            l=0,\n",
    "            r=15,\n",
    "            b=0,\n",
    "            t=170,\n",
    "            pad=0\n",
    "        ),\n",
    "        bargap=0,\n",
    "        #paper_bgcolor='#fcf9f0',#faf9ed\n",
    "        #plot_bgcolor='#f0eadf',#fcf8ed f0e8d5\n",
    "        coloraxis=dict(colorscale=[\"green\", \"#ffc832\", \"#cf0000\"], cmin=-max_value_diff, cmax=max_value_diff), \n",
    "                    coloraxis_colorbar=dict(\n",
    "                        title=\"Solde quotidien<br>d'hospitalisations{}<br> &#8205; \".format(by_million_legend),\n",
    "                        thicknessmode=\"pixels\", thickness=15,\n",
    "                        lenmode=\"pixels\", len=700,\n",
    "                        yanchor=\"bottom\", y=0.05, xanchor=\"left\", x=0.85,\n",
    "                        ticks=\"outside\", tickprefix=\"  \", ticksuffix=\" hosp.\",\n",
    "                        nticks=15,\n",
    "                        tickfont=dict(size=12),\n",
    "                        titlefont=dict(size=15)),\n",
    "                      \n",
    "                    showlegend=False,\n",
    "                    \n",
    "                    \n",
    "    \n",
    "                     title={\n",
    "                        'text': \"COVID19 : <b>nombre de personnes hospitalisées</b>{}<br><sub>Par ordre décroissant des hospitalisations actuelles - guillaumerozier.fr</sub>\".format(by_million_title),\n",
    "                        'y':0.97,\n",
    "                        'x':0.5,\n",
    "                        'xref':\"paper\",\n",
    "                         'yref':\"container\",\n",
    "                        'xanchor': 'center',\n",
    "                        'yanchor': 'middle'},\n",
    "                        titlefont = dict(\n",
    "                        size=35,\n",
    "                        )\n",
    "    )\n",
    "\n",
    "    fig[\"layout\"][\"annotations\"] += ( dict(\n",
    "                            x=0.9,\n",
    "                            y=0.015,\n",
    "                            xref='paper',\n",
    "                            yref='paper',\n",
    "                            xanchor='center',\n",
    "                            yanchor='top',\n",
    "                            text='Source :<br>Santé Publique France',\n",
    "                            showarrow = False,\n",
    "                            font=dict(size=12), \n",
    "                            opacity=0.5\n",
    "                        ),)\n",
    "    \n",
    "    name_fig = \"subplots_\" + val \n",
    "    fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=2, width=1300, height=1500)\n",
    "\n",
    "    fig[\"layout\"][\"annotations\"] += (\n",
    "                    dict(\n",
    "                        x=0.5,\n",
    "                        y=1,\n",
    "                        xref='paper',\n",
    "                        yref='paper',\n",
    "                        xanchor='center',\n",
    "                        text='Cliquez sur des éléments de légende pour les ajouter/supprimer',\n",
    "                        showarrow = False\n",
    "                        ),\n",
    "                        )\n",
    "    plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "    print(\"> \" + name_fig)\n",
    "\n",
    "\n",
    "    #fig.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 889,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "225      77.942957\n",
       "226     110.439551\n",
       "227     145.379498\n",
       "228     169.975917\n",
       "229     202.391065\n",
       "230     255.900494\n",
       "231     299.962291\n",
       "232     357.462529\n",
       "233     417.976236\n",
       "234     471.811445\n",
       "235     531.266365\n",
       "236     577.608625\n",
       "237     626.231348\n",
       "238     701.649508\n",
       "239     782.605934\n",
       "240     836.685478\n",
       "241     881.561726\n",
       "242     913.325314\n",
       "243     934.501039\n",
       "244     957.957227\n",
       "245     983.368097\n",
       "246    1016.353361\n",
       "247    1032.805270\n",
       "248    1047.465388\n",
       "249    1060.822384\n",
       "dtype: float64"
      ]
     },
     "execution_count": 889,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "data_r = df_region[df_region[\"regionName\"] == \"Ile-de-France\"]\n",
    "data_r[\"hosp\"]/data_r[\"regionPopulation\"]*1000000"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 890,
   "metadata": {},
   "outputs": [
    {
     "ename": "KeyError",
     "evalue": "'hosp_'",
     "output_type": "error",
     "traceback": [
      "\u001b[0;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[0;31mKeyError\u001b[0m                                  Traceback (most recent call last)",
      "\u001b[0;32m~/opt/anaconda3/lib/python3.7/site-packages/pandas/core/indexes/base.py\u001b[0m in \u001b[0;36mget_loc\u001b[0;34m(self, key, method, tolerance)\u001b[0m\n\u001b[1;32m   2896\u001b[0m             \u001b[0;32mtry\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m-> 2897\u001b[0;31m                 \u001b[0;32mreturn\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_engine\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mget_loc\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mkey\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m   2898\u001b[0m             \u001b[0;32mexcept\u001b[0m \u001b[0mKeyError\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n",
      "\u001b[0;32mpandas/_libs/index.pyx\u001b[0m in \u001b[0;36mpandas._libs.index.IndexEngine.get_loc\u001b[0;34m()\u001b[0m\n",
      "\u001b[0;32mpandas/_libs/index.pyx\u001b[0m in \u001b[0;36mpandas._libs.index.IndexEngine.get_loc\u001b[0;34m()\u001b[0m\n",
      "\u001b[0;32mpandas/_libs/hashtable_class_helper.pxi\u001b[0m in \u001b[0;36mpandas._libs.hashtable.PyObjectHashTable.get_item\u001b[0;34m()\u001b[0m\n",
      "\u001b[0;32mpandas/_libs/hashtable_class_helper.pxi\u001b[0m in \u001b[0;36mpandas._libs.hashtable.PyObjectHashTable.get_item\u001b[0;34m()\u001b[0m\n",
      "\u001b[0;31mKeyError\u001b[0m: 'hosp_'",
      "\nDuring handling of the above exception, another exception occurred:\n",
      "\u001b[0;31mKeyError\u001b[0m                                  Traceback (most recent call last)",
      "\u001b[0;32m<ipython-input-890-e1c1b92004f0>\u001b[0m in \u001b[0;36m<module>\u001b[0;34m\u001b[0m\n\u001b[0;32m----> 1\u001b[0;31m \u001b[0mdata_r\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mgroupby\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m[\u001b[0m\u001b[0;34m'jour'\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m'regionPopulation'\u001b[0m\u001b[0;34m]\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0msum\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mreset_index\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m[\u001b[0m\u001b[0;34m\"hosp_\"\u001b[0m\u001b[0;34m]\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m",
      "\u001b[0;32m~/opt/anaconda3/lib/python3.7/site-packages/pandas/core/frame.py\u001b[0m in \u001b[0;36m__getitem__\u001b[0;34m(self, key)\u001b[0m\n\u001b[1;32m   2993\u001b[0m             \u001b[0;32mif\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mcolumns\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mnlevels\u001b[0m \u001b[0;34m>\u001b[0m \u001b[0;36m1\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m   2994\u001b[0m                 \u001b[0;32mreturn\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_getitem_multilevel\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mkey\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m-> 2995\u001b[0;31m             \u001b[0mindexer\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mcolumns\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mget_loc\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mkey\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m   2996\u001b[0m             \u001b[0;32mif\u001b[0m \u001b[0mis_integer\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mindexer\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m   2997\u001b[0m                 \u001b[0mindexer\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0;34m[\u001b[0m\u001b[0mindexer\u001b[0m\u001b[0;34m]\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n",
      "\u001b[0;32m~/opt/anaconda3/lib/python3.7/site-packages/pandas/core/indexes/base.py\u001b[0m in \u001b[0;36mget_loc\u001b[0;34m(self, key, method, tolerance)\u001b[0m\n\u001b[1;32m   2897\u001b[0m                 \u001b[0;32mreturn\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_engine\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mget_loc\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mkey\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m   2898\u001b[0m             \u001b[0;32mexcept\u001b[0m \u001b[0mKeyError\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m-> 2899\u001b[0;31m                 \u001b[0;32mreturn\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_engine\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mget_loc\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m_maybe_cast_indexer\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mkey\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m   2900\u001b[0m         \u001b[0mindexer\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mget_indexer\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m[\u001b[0m\u001b[0mkey\u001b[0m\u001b[0;34m]\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mmethod\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0mmethod\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mtolerance\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0mtolerance\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m   2901\u001b[0m         \u001b[0;32mif\u001b[0m \u001b[0mindexer\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mndim\u001b[0m \u001b[0;34m>\u001b[0m \u001b[0;36m1\u001b[0m \u001b[0;32mor\u001b[0m \u001b[0mindexer\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0msize\u001b[0m \u001b[0;34m>\u001b[0m \u001b[0;36m1\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n",
      "\u001b[0;32mpandas/_libs/index.pyx\u001b[0m in \u001b[0;36mpandas._libs.index.IndexEngine.get_loc\u001b[0;34m()\u001b[0m\n",
      "\u001b[0;32mpandas/_libs/index.pyx\u001b[0m in \u001b[0;36mpandas._libs.index.IndexEngine.get_loc\u001b[0;34m()\u001b[0m\n",
      "\u001b[0;32mpandas/_libs/hashtable_class_helper.pxi\u001b[0m in \u001b[0;36mpandas._libs.hashtable.PyObjectHashTable.get_item\u001b[0;34m()\u001b[0m\n",
      "\u001b[0;32mpandas/_libs/hashtable_class_helper.pxi\u001b[0m in \u001b[0;36mpandas._libs.hashtable.PyObjectHashTable.get_item\u001b[0;34m()\u001b[0m\n",
      "\u001b[0;31mKeyError\u001b[0m: 'hosp_'"
     ]
    }
   ],
   "source": [
    "data_r.groupby(['jour', 'regionPopulation']).sum().reset_index()[\"hosp_\"]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "data_r_lastd = df[df[\"jour\"] == dates[-1]]\n",
    "data_r_lastd = data_r_lastd.groupby(\"regionName\").sum().reset_index()\n",
    "\n",
    "data_r_lastd.sort_values(by=['hosp'], ascending=False)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "data_r = df[df[\"regionName\"] == region]\n",
    "data_r[\"hosp_new\"] = data_r[\"hosp\"].diff()\n",
    "data_r"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "fig = go.Figure()\n",
    "\n",
    "fig.add_trace(go.Bar(\n",
    "    x = df_france_last15[\"jour\"],\n",
    "    y = df_france_last15[\"dc_new\"],\n",
    "    name = \"Nouveaux décès hosp.\",\n",
    "    marker_color='black',\n",
    "    opacity=0.6\n",
    "))\n",
    "\n",
    "fig.add_trace(go.Bar(\n",
    "    x = df_france_last15[\"jour\"],\n",
    "    y = df_france_last15[\"rea_new\"],\n",
    "    name = \"<b>Variation</b> réanimations\",\n",
    "    marker_color='red',\n",
    "    opacity=0.6\n",
    "))\n",
    "\n",
    "fig.add_trace(go.Bar(\n",
    "    x = df_france_last15[\"jour\"],\n",
    "    y = df_france_last15[\"hosp_nonrea_new\"],\n",
    "    name = \"<b>Variation</b> autres hospit.\",\n",
    "    marker_color='grey',\n",
    "    opacity=0.6\n",
    "))\n",
    "\n",
    "fig.add_trace(go.Bar(\n",
    "    x = df_france_last15[\"jour\"],\n",
    "    y = df_france_last15[\"rad_new\"],\n",
    "    name = \"Nouv. retours à domicile\",\n",
    "    marker_color='green',\n",
    "    opacity=0.6\n",
    "))\n",
    "\n",
    "# Here we modify the tickangle of the xaxis, resulting in rotated labels.\n",
    "fig.update_layout(\n",
    "    barmode='group',\n",
    "    title={\n",
    "                'text': \"<b>COVID-19 : variation quotidienne en France</b>\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "                titlefont = dict(\n",
    "                size=20),\n",
    "    xaxis=dict(\n",
    "        title='',\n",
    "        tickformat='%d/%m',\n",
    "        nticks=100),\n",
    "    yaxis_title=\"Nb. de personnes\",\n",
    "    \n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "\n",
    "name_fig = \"var_journ\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1400, height=800)\n",
    "\n",
    "fig.update_layout(\n",
    "    legend_orientation=\"h\",\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0.5,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    xanchor='center',\n",
    "                    text='Cliquez sur des éléments de légende pour les ajouter/supprimer',\n",
    "                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "scrolled": true
   },
   "outputs": [],
   "source": [
    "\n",
    "df_region_sumj = df_region.groupby('jour').sum().reset_index()\n",
    "df_region_sumj = pd.melt(df_region_sumj, id_vars=['jour'], value_vars=['rad', 'rea', 'dc', 'hosp_nonrea'])\n",
    "df_region_sumj.drop(df_region_sumj[df_region_sumj['jour'].isin(['Guyane', 'Mayote', 'La Réunion', 'Guadeloupe', 'Martinique'])].index, inplace = True)\n",
    "df_bar = df_region_sumj\n",
    "\n",
    "data = df_bar[df_bar[\"variable\"] == \"dc\"]\n",
    "fig = go.Figure(go.Bar(x=data['jour'], y=data['value'], text=data['value'], textposition='auto', name='Décès hosp.', marker_color='#000000', opacity=0.8))\n",
    "\n",
    "data = df_bar[df_bar[\"variable\"] == \"rea\"]\n",
    "fig.add_trace(go.Bar(x=data['jour'], y=data['value'], text=data['value'], textposition='auto', name='Réanimation', marker_color='#FF0000', opacity=0.8))\n",
    "\n",
    "data = df_bar[df_bar[\"variable\"] == \"hosp_nonrea\"]\n",
    "fig.add_trace(go.Bar(x=data['jour'], y=data['value'], text= data['value'], textposition='auto', name='Autre hospitalisation', marker_color='#FFA200', opacity=0.8))\n",
    "\n",
    "if len(df_confirmed[df_confirmed[\"date\"].isin([dates[-1]])]) > 0:\n",
    "    data = df_confirmed[df_confirmed[\"date\"].isin(dates)].reset_index()\n",
    "    sum_df = df_bar[df_bar[\"variable\"] == \"dc\"]['value'].reset_index() + df_bar[df_bar[\"variable\"] == \"rea\"]['value'].reset_index() +  df_bar[df_bar[\"variable\"] == \"hosp_nonrea\"]['value'].reset_index() + df_bar[df_bar[\"variable\"] == \"rad\"]['value'].reset_index()\n",
    "    fig.add_trace(go.Bar(x=data['date'], y=data['France'] - sum_df['value'], text = data['France'] - sum_df['value'], textposition='auto', name='Non hospitalisés', marker_color='grey', opacity=0.8))\n",
    "\n",
    "data = df_bar[df_bar[\"variable\"] == \"rad\"]\n",
    "\n",
    "fig.add_trace(go.Bar(x=data['jour'], y=data['value'], text= data['value'], textposition='auto', name='Retour à domicile', marker_color='green', opacity=0.8))\n",
    "fig.update_yaxes(title=\"Nb. de cas\")\n",
    "\n",
    "fig.update_layout(\n",
    "            barmode='stack',\n",
    "            title={\n",
    "                'text': \"Évolution de la <b>situation des malades</b> du Covid-19\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "            titlefont = dict(\n",
    "                size=20),\n",
    "            xaxis=dict(\n",
    "                title='',\n",
    "                tickformat='%d/%m',\n",
    "                nticks=len(dates)+5\n",
    "            ),\n",
    "            annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),\n",
    "                    showarrow = False\n",
    "                )]\n",
    ")\n",
    "\n",
    "name_fig = \"situation_cas\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=700)\n",
    "\n",
    "fig.update_layout(\n",
    "    legend_orientation=\"h\",\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0.5,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    xanchor='center',\n",
    "                    text='Cliquez sur des éléments de légende pour les ajouter/supprimer',\n",
    "                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<br>\n",
    "<br>\n",
    "<br>\n",
    "<br>\n",
    "\n",
    "## Line charts"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_france = df.groupby('jour').sum().reset_index()\n",
    "\n",
    "#fig = go.Figure()\n",
    "fig = make_subplots(specs=[[{\"secondary_y\": True}]])\n",
    "fig.add_trace(go.Scatter(x=df_france['jour'], y=df_france['rea'],\n",
    "                    mode='lines+markers',\n",
    "                    name=\"Réanimations\", #(<i>axe de gauche</i>)\n",
    "                    line=dict(width=2),\n",
    "                    marker_size=8,\n",
    "                            ))\n",
    "fig.add_trace(go.Scatter(x=df_france['jour'], y=df_france['dc'],\n",
    "                    mode='lines+markers',\n",
    "                    name=\"décès hospitaliers cumulés\", #(<i>axe de droite</i>)\n",
    "                    line=dict(width=2),\n",
    "                    marker_size=8,\n",
    "                    \n",
    "                            ),\n",
    "             #secondary_y=True\n",
    "             )\n",
    "fig.add_trace(go.Scatter(x=df_france['jour'], y=df_france['hosp_nonrea'],\n",
    "                    mode='lines+markers',\n",
    "                    name=\"Autres hospitalisations\", #(<i>axe de gauche</i>)\n",
    "                    line=dict(width=2),\n",
    "                    marker_size=8,\n",
    "                            ))\n",
    "    \n",
    "#fig = px.line(, color_discrete_sequence=colors).update_traces(mode='lines+markers', marker_size=7.5, line=dict(width=2.5))\n",
    "fig.update_layout(\n",
    "    legend_orientation=\"v\",\n",
    "    title={\n",
    "                'text': \"Nombre d'<b>hospitalisations et réanimations</b> et <b>décès</b> \", #(<i>Attention ! Axes distincs</i>)\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "        titlefont = dict(\n",
    "                size=20),\n",
    "        annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier.'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "fig.update_xaxes(title=\"Jour\")\n",
    "fig.update_yaxes(title=\"Nb. de personnes (réa et hosp)\")\n",
    "fig.update_yaxes(title=\"Nb. de décès hosp.\", secondary_y=True)\n",
    "\n",
    "name_fig = \"dc_hosp_rea_line\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=700)\n",
    "\n",
    "\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "\n",
    "if show_charts:\n",
    "    fig.show()\n",
    "print(\"> \" + name_fig)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "fig = px.line(x=df_region['jour'], y=df_region['dc'], color=df_region[\"regionName\"], color_discrete_sequence=colors).update_traces(mode='lines+markers', marker_size=7.5, line=dict(width=2.5))\n",
    "fig.update_layout(\n",
    "    title={\n",
    "                'text': \"Nombre de <b>décès cumulés</b>\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "        titlefont = dict(\n",
    "                size=20),\n",
    "        annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier.'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "fig.update_xaxes(title=\"Jour\")\n",
    "fig.update_yaxes(title=\"Nb. de décès hosp. cumulés\")\n",
    "\n",
    "name_fig = \"dc_cum_line\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=700)\n",
    "\n",
    "\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "fig = px.line(x = df_new_region['jour'], y = df_new_region['incid_dc'], color = df_new_region[\"regionName\"], color_discrete_sequence=colors).update_traces(mode='lines+markers', marker_size=7.5, line=dict(width=2.5))\n",
    "fig.update_layout(\n",
    "    title={\n",
    "                'text': \"Nombre de <b>décès quotidiens</b>\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "        titlefont = dict(\n",
    "                size=20),\n",
    "        annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier.'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "fig.update_xaxes(title=\"Jour\")\n",
    "fig.update_yaxes(title=\"Nb. de décès hosp. en 24h\")\n",
    "\n",
    "name_fig = \"dc_journ_line\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=700)\n",
    "\n",
    "\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Hospitalisations"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "scrolled": true
   },
   "outputs": [],
   "source": [
    "\n",
    "fig = px.line(x=df_region['jour'], y=df_region['hosp'], color=df_region[\"regionName\"], color_discrete_sequence=colors).update_traces(mode='lines+markers', marker_size=7.5, line=dict(width=2.5))\n",
    "fig.update_layout(\n",
    "    title={\n",
    "                'text': \"Nombre de <b>patients hospitalisés</b>\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "        titlefont = dict(\n",
    "                size=20),\n",
    "        annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier.'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "fig.update_xaxes(title=\"Jour\")\n",
    "fig.update_yaxes(title=\"Nb. de patients hospitalisés\")\n",
    "\n",
    "name_fig = \"hosp_line\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=700)\n",
    "\n",
    "\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "fig = px.line(x=df_region['jour'], y=df_region['hosp_new'], color=df_region[\"regionName\"], color_discrete_sequence=colors).update_traces(mode='lines+markers', marker_size=7.5, line=dict(width=2.5))\n",
    "fig.update_layout(\n",
    "    title={\n",
    "                'text': \"<b>Variation des hospitalisations</b> (entrées - sorties)\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "        titlefont = dict(\n",
    "                size=20),\n",
    "        annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier.'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "fig.update_xaxes(title=\"Jour\")\n",
    "fig.update_yaxes(title=\"Nb. de nouveaux patients hospitalisés\")\n",
    "\n",
    "name_fig = \"hosp_variation_journ_line\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=700)\n",
    "\n",
    "\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "fig = px.line(x = df_new_region['jour'], y = df_new_region['incid_hosp'], color = df_new_region[\"regionName\"], color_discrete_sequence=colors).update_traces(mode='lines+markers', marker_size=7.5, line=dict(width=2.5))\n",
    "fig.update_layout(\n",
    "    title={\n",
    "                'text': \"<b>Nouvelles admissions en hospitalisation</b>\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "        titlefont = dict(\n",
    "                size=20),\n",
    "        annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier.'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "fig.update_xaxes(title=\"Jour\")\n",
    "fig.update_yaxes(title=\"Admissions hospitalisations\")\n",
    "\n",
    "name_fig = \"hosp_admissions_journ_line\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=700)\n",
    "\n",
    "\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Réanimations par région"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "scrolled": true
   },
   "outputs": [],
   "source": [
    "fig = px.line(x=df_region['jour'], y=df_region['rea'], color=df_region[\"regionName\"], color_discrete_sequence=colors).update_traces(mode='lines+markers', marker_size=7.5, line=dict(width=2.5))\n",
    "fig.update_layout(\n",
    "    title={\n",
    "                'text': \"Nombre de <b>patients en réanimation</b>\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "        titlefont = dict(\n",
    "                    size=20),\n",
    "        annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "fig.update_xaxes(title=\"Jour\")\n",
    "fig.update_yaxes(title=\"Nb. de patients en réanimation\")\n",
    "\n",
    "name_fig = \"rea_line\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=700)\n",
    "\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Réanimations : Rhin"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_rhin = df[df[\"dep\"].isin([\"67\", \"68\"])]\n",
    "fig = px.line(x=df_rhin['jour'], y=df_rhin['rea'], color=df_rhin[\"dep\"], labels={'color':'Département'}, color_discrete_sequence=colors).update_traces(mode='lines+markers')\n",
    "\n",
    "fig.update_layout(\n",
    "    title={\n",
    "                'text': \"Nombre de <b>patients en réanimation</b> en Ht et Bas Rhin\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "        titlefont = dict(\n",
    "                    size=20),\n",
    "        annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "fig.update_xaxes(title=\"Jour\")\n",
    "fig.update_yaxes(title=\"Nb. de patients en réa. ou soins intensifs\")\n",
    "\n",
    "name_fig = \"rea_rhin\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=700)\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Réanimations par département"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "scrolled": false
   },
   "outputs": [],
   "source": [
    "df_last_d = df[df['jour'] == dates[-1]]\n",
    "#deps_ordered = df_last_d.sort_values(by=['rea'], ascending=False)[\"dep\"].values\n",
    "deps_ordered = df_last_d.sort_values(by=['dep'], ascending=True)[\"dep\"].values\n",
    "\n",
    "fig = go.Figure()\n",
    "for dep in deps_ordered:\n",
    "    fig.add_trace(go.Scatter(x=df['jour'], y=df[df[\"dep\"] == dep][\"rea\"],\n",
    "                    mode='lines+markers',\n",
    "                    name=dep,\n",
    "                    line=dict(width=2),\n",
    "                    marker_size=8,\n",
    "                            ))\n",
    "\n",
    "fig.update_layout(\n",
    "    title={\n",
    "                'text': \"Nb. de <b>patients en réanimation</b> par département\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "    titlefont = dict(\n",
    "                size=20),\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "fig.update_xaxes(title=\"\")\n",
    "fig.update_yaxes(title=\"Nb. de patients en réa. ou soins intensifs\")\n",
    "\n",
    "name_fig = \"rea_dep\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=700)\n",
    "\n",
    "fig.update_layout(\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0.5,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    xanchor='center',\n",
    "                    text='Cliquez sur des éléments de légende pour les ajouter/supprimer',\n",
    "                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<br>\n",
    "\n",
    "### Hospitalisations par habitant / région"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\"\"\"\n",
    "fig = px.line(x=df_region['jour'], y=df_region['hosp_pop'], labels={'color':'Région'}, color=df_region[\"regionName\"], color_discrete_sequence=colors)\n",
    "fig.update_layout(\n",
    "    title={\n",
    "                'text': \"Nb. de <b>patients hospitalisés</b> <b>par habitant</b>\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "        titlefont = dict(\n",
    "        size=20),\n",
    "        annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "fig.update_xaxes(title=\"Jour\")\n",
    "fig.update_yaxes(title=\"Nb. de patients hospitalisés/100k hab. (de ch. région)\")\n",
    "\n",
    "name_fig = \"hosp_hab\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=700)\n",
    "\n",
    "fig.update_layout(\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0.5,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    xanchor='center',\n",
    "                    text='Cliquez sur des éléments de légende pour les ajouter/supprimer',\n",
    "                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "if show_charts:\n",
    "    fig.show()\n",
    "\"\"\""
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<br>\n",
    "\n",
    "### Capacité réanimation"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "df_rean = df.groupby('jour').sum().reset_index()\n",
    "df_rean[\"lim_rea_prev\"] = [14000 for i in range(len(dates))]\n",
    "df_rean[\"lim_rea\"] = [10000 for i in range(len(dates))]\n",
    "df_rean = pd.melt(df_rean, id_vars=['jour'], value_vars=['rea', 'lim_rea', 'lim_rea_prev'])\n",
    "\n",
    "fig = go.Figure()\n",
    "fig.add_trace(go.Scatter(x=df_rean['jour'], y=df_rean[df_rean['variable'] == 'rea']['value'],\n",
    "                    mode='lines+markers',\n",
    "                    name='Nb. patients réa.',\n",
    "                    line=dict(width=4),\n",
    "                    marker_size=11,))\n",
    "\n",
    "fig.add_trace(go.Scatter(x=df_rean['jour'], y=df_rean[df_rean['variable'] == 'lim_rea_prev']['value'],\n",
    "                    mode='lines',\n",
    "                    name='Capacité max. prévue',\n",
    "                    line=dict(width=4),\n",
    "                    marker_size=11,))\n",
    "\n",
    "fig.add_trace(go.Scatter(x=df_rean['jour'], y=df_rean[df_rean['variable'] == 'lim_rea']['value'],\n",
    "                    mode='lines',\n",
    "                    name='Capacité approx. actuelle',\n",
    "                    line=dict(width=4),\n",
    "                    marker_size=11,))\n",
    "\n",
    "fig.update_layout(\n",
    "    title={\n",
    "                'text': \"Nb. de <b>patients en réanimation</b> et de lits disponibles\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "        titlefont = dict(\n",
    "            size=20),\n",
    "        annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "\n",
    "name_fig = \"capacite_rea\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1000, height=700)\n",
    "\n",
    "fig.update_layout(\n",
    "    legend_orientation=\"h\",\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0.5,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    xanchor='center',\n",
    "                    text='Cliquez sur des éléments de légende pour les ajouter/supprimer',\n",
    "                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<br>\n",
    "\n",
    "### Décès cumulés (région)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "fig = px.line(x=df_region['jour'], y=df_region['dc'], color=df_region[\"regionName\"], labels={'color':'Région'}, color_discrete_sequence=colors).update_traces(mode='lines+markers')\n",
    "fig.update_layout(\n",
    "    title={\n",
    "                'text': \"Nombre de <b>décès cumulés</b> par région\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "        titlefont = dict(\n",
    "        size=20),\n",
    "    \n",
    "        annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "fig.update_xaxes(title=\"Jour\")\n",
    "fig.update_yaxes(title=\"Nb. de décès hosp. cumulés\")\n",
    "\n",
    "name_fig = \"dc_cum_line\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=700)\n",
    "\n",
    "fig.update_layout(\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0.5,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    xanchor='center',\n",
    "                    text='Cliquez sur des éléments de légende pour les ajouter/supprimer',\n",
    "                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "fig = px.line(x=df_new_region['jour'], y=df_new_region['incid_dc'], color=df_new_region[\"regionName\"], labels={'color':'Région'}, color_discrete_sequence=colors).update_traces(mode='lines+markers')\n",
    "fig.update_layout(\n",
    "    title={\n",
    "                'text': \"<b>Nouveaux décès</b> par région\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "        titlefont = dict(\n",
    "        size=20),\n",
    "    \n",
    "        annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "fig.update_xaxes(title=\"Jour\")\n",
    "fig.update_yaxes(title=\"Nb. de décès hosp.\")\n",
    "\n",
    "name_fig = \"dc_nouv_line\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=700)\n",
    "\n",
    "fig.update_layout(\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0.5,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    xanchor='center',\n",
    "                    text='Cliquez sur des éléments de légende pour les ajouter/supprimer',\n",
    "                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<br>\n",
    "\n",
    "### Décès cumulés par habitant (région)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\"\"\"\n",
    "fig = px.line(x=df_region['jour'], y = df_region['dc']/df_region['regionPopulation']*100000, labels={'color':'Région'}, color=df_region[\"regionName\"], color_discrete_sequence=colors)\n",
    "\n",
    "fig.update_layout(\n",
    "    title={\n",
    "                'text': \"Nombre de <b>décès cumulés</b> par <b>habitant</b>\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "        titlefont = dict(\n",
    "        size=20),\n",
    "        annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "\n",
    "fig.update_xaxes(title=\"Jour\")\n",
    "fig.update_yaxes(title=\"Nb. décès cumulés / 100k hab. de chaq. région\")\n",
    "\n",
    "name_fig = \"dc_cum_hab_line\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=700)\n",
    "\n",
    "fig.update_layout(\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0.5,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    xanchor='center',\n",
    "                    text='Cliquez sur des éléments de légende pour les ajouter/supprimer',\n",
    "                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "if show_charts:\n",
    "    fig.show()\n",
    "\"\"\""
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<br>\n",
    "<br>\n",
    "<br>\n",
    "<br>\n",
    "\n",
    "# Bar charts"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<br>\n",
    "\n",
    "### Décès cumulés par région / temps"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "fig = px.bar(x=df_region['jour'], y = df_region['dc'], color=df_region[\"regionName\"], labels={'color':'Région'}, color_discrete_sequence=colors, opacity=0.9)\n",
    "\n",
    "fig.update_layout(\n",
    "    title={\n",
    "                'text': \"Nombre de <b>décès cumulés</b> par région\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "        titlefont = dict(\n",
    "        size=20),\n",
    "        annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "    \n",
    "                 )\n",
    "fig.update_xaxes(title=\"\")\n",
    "fig.update_yaxes(title=\"Nb. de décès cumulés\")\n",
    "#fig.show()\n",
    "\n",
    "name_fig = \"dc_cum_region\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=500)\n",
    "\n",
    "fig.update_layout(\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0.5,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    xanchor='center',\n",
    "                    text='Cliquez sur des éléments de légende pour les ajouter/supprimer',\n",
    "                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<br>\n",
    "\n",
    "### Décès cumulés par région / 3 derniers jours"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "#df_region4 = df_region.groupby(\"regionName\", \"jour\").sum().reset_index()\n",
    "df_region_sans = df_region.drop( df_region[ df_region[\"regionName\"].isin([\"Martinique\", \"Guadeloupe\", \"Guyane\", \"La Réunion\"]) ].index)\n",
    "fig = go.Figure()\n",
    "\n",
    "\n",
    "fig.add_trace(go.Bar(\n",
    "    x = df_region_sans[df_region_sans[\"jour\"] == dates[-4]]['regionName'],\n",
    "    y = df_region_sans[df_region_sans[\"jour\"] == dates[-4]]['dc'],\n",
    "    name = datetime.strptime(dates[-4], '%Y-%m-%d').strftime('%d %B'),\n",
    "    marker_color='indianred',\n",
    "    opacity=0.3\n",
    ")).update_xaxes(categoryorder=\"total ascending\")\n",
    "\n",
    "fig.add_trace(go.Bar(\n",
    "    x = df_region_sans[df_region_sans[\"jour\"] == dates[-3]]['regionName'],\n",
    "    y = df_region_sans[df_region_sans[\"jour\"] == dates[-3]]['dc'],\n",
    "    name = datetime.strptime(dates[-3], '%Y-%m-%d').strftime('%d %B'),\n",
    "    marker_color='indianred',\n",
    "    opacity=0.4\n",
    "))\n",
    "\n",
    "fig.add_trace(go.Bar(\n",
    "    x = df_region_sans[df_region_sans[\"jour\"] == dates[-2]]['regionName'],\n",
    "    y = df_region_sans[df_region_sans[\"jour\"] == dates[-2]]['dc'],\n",
    "    name = datetime.strptime(dates[-2], '%Y-%m-%d').strftime('%d %B'),\n",
    "    marker_color='indianred',\n",
    "    opacity=0.5\n",
    "))\n",
    "\n",
    "fig.add_trace(go.Bar(\n",
    "    x = df_region_sans[df_region_sans[\"jour\"] == dates[-1]]['regionName'],\n",
    "    y = df_region_sans[df_region_sans[\"jour\"] == dates[-1]]['dc'],\n",
    "    name = datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B'),\n",
    "    marker_color='indianred'\n",
    ")).update_xaxes(categoryorder=\"total ascending\")\n",
    "\n",
    "\n",
    "# Here we modify the tickangle of the xaxis, resulting in rotated labels.\n",
    "fig.update_layout(\n",
    "    barmode='group', xaxis_tickangle=-45,\n",
    "    \n",
    "    title={\n",
    "                'text': \"<b>Décès cumulés</b> par région\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "                titlefont = dict(\n",
    "                size=20),\n",
    "    xaxis_title=\"\",\n",
    "    yaxis_title=\"Nb. de décès cumulés\",\n",
    "        annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "\n",
    "name_fig = \"dc_cum_region_comp\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1300, height=600)\n",
    "\n",
    "fig.update_layout(\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0.5,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    xanchor='center',\n",
    "                    text='Cliquez sur des éléments de légende pour les ajouter/supprimer',\n",
    "                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<br>\n",
    "\n",
    "### Décès cumulés VS. Décès cumulés par habitant / région"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "scrolled": true
   },
   "outputs": [],
   "source": [
    "fig = go.Figure()\n",
    "df_region3 = df_region[df_region[\"jour\"] == dates[-1]].groupby(\"regionName\").sum().reset_index()\n",
    "fig = make_subplots(specs=[[{\"secondary_y\": True}]])\n",
    "fig.add_trace(go.Bar(\n",
    "    x=df_region3['regionName'], \n",
    "    y = df_region3['dc'],\n",
    "    name = \"Nombre décès cumulés\",\n",
    "    width=0.3,\n",
    "    marker_color='indianred'\n",
    "),\n",
    "             secondary_y = False).update_xaxes(categoryorder=\"total descending\")\n",
    "\n",
    "fig.add_trace(go.Bar(\n",
    "    x=df_region3['regionName'], \n",
    "    y = df_region3['dc_pop'],\n",
    "    name = \"Nb. décès cum./100k hab.\",\n",
    "    marker_color='indianred',\n",
    "    opacity=0.6,\n",
    "    width=0.3,\n",
    "    offset=0.15\n",
    "    \n",
    "),\n",
    "             secondary_y = True)\n",
    "\n",
    "fig.update_layout(\n",
    "    barmode='group', \n",
    "    xaxis_tickangle=-45,\n",
    "    \n",
    "    title={\n",
    "                'text': \"Comparaison des <b>décès cumulés</b> et <b>décès cumulés par habitant</b>\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "                titlefont = dict(\n",
    "                size=20),\n",
    "    xaxis_title=\"\",\n",
    "        annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "fig.update_yaxes(title_text=\"Nb. décès cumulés\", secondary_y=False)\n",
    "fig.update_yaxes(title_text=\"Nb. décès cumulés/100k hab.\", secondary_y=True)\n",
    "\n",
    "name_fig = \"dc_cum_hab_nonhab_comp\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=700)\n",
    "\n",
    "fig.update_layout(\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0.5,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    xanchor='center',\n",
    "                    text='Cliquez sur des éléments de légende pour les ajouter/supprimer',\n",
    "                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<br>\n",
    "\n",
    "### Situation des malades / temps"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<br>\n",
    "\n",
    "### Situation des malades / région"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "#df_region_sumj = df_region.groupby('regionName').sum().reset_index()\n",
    "df_region_sumj = df_region[df_region['jour'] == dates[-1]]\n",
    "\n",
    "df_region_sumj = pd.melt(df_region_sumj, id_vars=['regionName'], value_vars=['rad', 'rea', 'dc', 'hosp_nonrea'])\n",
    "df_region_sumj.drop(df_region_sumj[df_region_sumj['regionName'].isin(['Guyane', 'Mayote', 'La Réunion', 'Guadeloupe', 'Martinique'])].index, inplace = True)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "data = df_region_sumj[df_region_sumj[\"variable\"] == \"dc\"]\n",
    "fig = go.Figure(go.Bar(x=data['regionName'], y=data['value'], text=data['value'], textposition='auto', name='Décès', marker_color='#000000', opacity=0.8))\n",
    "\n",
    "data = df_region_sumj[df_region_sumj[\"variable\"] == \"rea\"]\n",
    "fig.add_trace(go.Bar(x=data['regionName'], y=data['value'], text=data['value'], textposition='auto', name='Réanimation', marker_color='#FF0000', opacity=0.8))\n",
    "\n",
    "data = df_region_sumj[df_region_sumj[\"variable\"] == \"hosp_nonrea\"]\n",
    "fig.add_trace(go.Bar(x=data['regionName'], y=data['value'], text= data['value'], textposition='auto', name='Autre hospitalisation', marker_color='#FFA200', opacity=0.8))\n",
    "\n",
    "data = df_region_sumj[df_region_sumj[\"variable\"] == \"rad\"]\n",
    "fig.add_trace(go.Bar(x=data['regionName'], y=data['value'], text= data['value'], textposition='auto', name='Retour à domicile', marker_color='green', opacity=0.8))\n",
    "fig.update_yaxes(title=\"Nb. de cas\")\n",
    "\n",
    "fig.update_layout(\n",
    "            barmode='stack',\n",
    "            title={\n",
    "                'text': \"<b>Situation des malades hospitalisés</b> du Covid-19\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "            titlefont = dict(\n",
    "                size=20),\n",
    "            xaxis=dict(\n",
    "                title='',\n",
    "                tickformat='%d/%m',\n",
    "                nticks=len(dates)+5\n",
    "            ),\n",
    "            annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    \n",
    "                    showarrow = False\n",
    "                )]\n",
    ")\n",
    "fig.update_xaxes(categoryorder=\"total descending\")     \n",
    "\n",
    "name_fig = \"situation_cas_region\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=700)\n",
    "\n",
    "fig.update_layout(\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0.5,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    xanchor='center',\n",
    "                    text='Cliquez sur des éléments de légende pour les ajouter/supprimer',\n",
    "                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<br>\n",
    "\n",
    "### Situation des malades par habitant / région"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_region_sumj = df_region[df_region['jour'] == dates[-1]]\n",
    "df_region_sumj = pd.melt(df_region_sumj, id_vars=['regionName'], value_vars=['rad_pop', 'rea_pop', 'dc_pop', 'hosp_nonrea_pop'])\n",
    "df_region_sumj.drop(df_region_sumj[df_region_sumj['regionName'].isin(['Guyane', 'Mayote', 'La Réunion', 'Guadeloupe', 'Martinique'])].index, inplace = True)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "data = df_region_sumj[df_region_sumj[\"variable\"] == \"dc_pop\"]\n",
    "fig = go.Figure(go.Bar(x=data['regionName'], y=data['value'], text=round(data['value']), textposition='auto', name='Décès/100k hab.', marker_color='black', opacity=0.7))\n",
    "\n",
    "data = df_region_sumj[df_region_sumj[\"variable\"] == \"rea_pop\"]\n",
    "fig.add_trace(go.Bar(x=data['regionName'], y=data['value'], text=round(data['value']), textposition='auto', name='Réanimation/100k hab.', marker_color='red', opacity=0.7))\n",
    "\n",
    "data = df_region_sumj[df_region_sumj[\"variable\"] == \"hosp_nonrea_pop\"]\n",
    "fig.add_trace(go.Bar(x=data['regionName'], y=data['value'], text= round(data['value']), textposition='auto', name='Autre hospitalisation/100k hab.', marker_color='#FFA200', opacity=0.7))\n",
    "\n",
    "data = df_region_sumj[df_region_sumj[\"variable\"] == \"rad_pop\"]\n",
    "fig.add_trace(go.Bar(x=data['regionName'], y=data['value'], text=round(data['value']), textposition='auto', name='Retour à dom./100k hab', marker_color='green', opacity=0.7))\n",
    "fig.update_yaxes(title=\"Nb. de cas\")\n",
    "\n",
    "fig.update_layout(\n",
    "            barmode='stack',\n",
    "            title={\n",
    "                'text': \"<b>Situation des malades hospitalisés</b> du Covid-19 <b>par habitant</b>\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "            titlefont = dict(\n",
    "                size=20),\n",
    "            xaxis=dict(\n",
    "                title='',\n",
    "                tickformat='%d/%m',\n",
    "                nticks=len(dates)+5\n",
    "            ),\n",
    "            annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),\n",
    "                    showarrow = False\n",
    "                )]\n",
    ")\n",
    "fig.update_xaxes(categoryorder=\"total descending\")        \n",
    "\n",
    "name_fig = \"situation_cas_region_hab\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=700)\n",
    "\n",
    "fig.update_layout(\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0.5,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    xanchor='center',\n",
    "                    text='Cliquez sur des éléments de légende pour les ajouter/supprimer',\n",
    "                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "print(\"> \" + name_fig)\n",
    "if show_charts:\n",
    "    fig.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<br>\n",
    "\n",
    "### Évolution qutotidienne / temps"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<br>\n",
    "<br>\n",
    "<br>\n",
    "<br>\n",
    "\n",
    "# Expérimentations"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\"\"\"\n",
    "df_region_last_d = df_region[df_region['jour'] == dates[-1]]\n",
    "reg_ordered = df_region_last_d.sort_values(by=['rea'], ascending=False)[\"regionName\"].values\n",
    "\n",
    "fig = go.Figure()\n",
    "for reg in tqdm(reg_ordered):\n",
    "    showld = True\n",
    "    for dep in deps_ordered:\n",
    "        fig.add_trace(go.Scatter(x=df['jour'], y=df[ (df[\"regionName\"] == reg) & (df[\"dep\"] == dep) ][\"rea\"],\n",
    "                        mode='lines+markers',\n",
    "                        legendgroup = reg,\n",
    "                        name = dep,\n",
    "                        marker = dict(color = colors[list(reg_ordered).index(reg)]),\n",
    "                        line=dict(width=1.5),\n",
    "                        showlegend = showld))\n",
    "        showld = False\n",
    "\n",
    "fig.update_layout(\n",
    "    title={\n",
    "                'text': \"Nb. de <b>patients en réanimation</b> par région\",\n",
    "                'y':0.95,\n",
    "                'x':0.5,\n",
    "                'xanchor': 'center',\n",
    "                'yanchor': 'top'},\n",
    "    titlefont = dict(\n",
    "                size=20),\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0,\n",
    "                    y=1,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    text='Date : {}. Source : INSEE et CSSE. Auteur : @guillaumerozier (Twitter).'.format(datetime.strptime(dates[-1], '%Y-%m-%d').strftime('%d %B %Y')),                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "fig.update_xaxes(title=\"\")\n",
    "fig.update_yaxes(title=\"Nb. de patients en réanimation\")\n",
    "\n",
    "name_fig = \"rea_reg\"\n",
    "fig.write_image(\"images/charts/france/{}.png\".format(name_fig), scale=3, width=1100, height=700)\n",
    "\n",
    "fig.update_layout(\n",
    "    annotations = [\n",
    "                dict(\n",
    "                    x=0.5,\n",
    "                    y=1.05,\n",
    "                    xref='paper',\n",
    "                    yref='paper',\n",
    "                    xanchor='center',\n",
    "                    text='Cliquez sur des éléments de légende pour les ajouter/supprimer',\n",
    "                    showarrow = False\n",
    "                )]\n",
    "                 )\n",
    "plotly.offline.plot(fig, filename = 'images/html_exports/france/{}.html'.format(name_fig), auto_open=False)\n",
    "\n",
    "if show_charts:\n",
    "    fig.show()\n",
    "\"\"\""
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.7.4"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
